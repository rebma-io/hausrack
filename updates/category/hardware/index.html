
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="A wildly over-engineered home automation project">
      
      
        <meta name="author" content="Christopher Petrilli">
      
      
      
      
      
        <link rel="alternate" type="application/rss+xml" title="RSS feed" href="../../../feed_rss_created.xml">
        <link rel="alternate" type="application/rss+xml" title="RSS feed of updated content" href="../../../feed_rss_updated.xml">
      
      <link rel="icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.0, mkdocs-material-9.5.21">
    
    
      
        <title>Hardware - HAUSRACK</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.66ac8b77.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Fira+Sans:300,300i,400,400i,700,700i%7CFira+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Fira Sans";--md-code-font:"Fira Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      
  


  <!-- Fathom - beautiful, simple website analytics -->
<script src="https://cdn.usefathom.com/script.js" data-site="ZIPCWPRA" defer></script>
<!-- / Fathom -->
  
    <script>"undefined"!=typeof __md_analytics&&__md_analytics()</script>
  

    
    
    
  <link rel="alternate" type="application/rss+xml" title="Subscribe to Changes" href="/feed_rss_updated.xml" />

  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="black" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#hardware" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="HAUSRACK" class="md-header__button md-logo" aria-label="HAUSRACK" data-md-component="logo">
      
  <img src="../../../hausrack-logo.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            HAUSRACK
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Hardware
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/rebma-io/hausrack" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.5.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    rebma-io/hausrack
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../.." class="md-tabs__link">
        
  
    
  
  Home

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../../design/" class="md-tabs__link">
        
  
    
  
  Design

      </a>
    </li>
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../hardware/" class="md-tabs__link">
          
  
  Hardware

        </a>
      </li>
    
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../../software/" class="md-tabs__link">
        
  
    
  
  Software

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../" class="md-tabs__link">
        
  
    
  
  Project Updates

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../../CHANGELOG/" class="md-tabs__link">
        
  
    
  
  Changelog

      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="HAUSRACK" class="md-nav__button md-logo" aria-label="HAUSRACK" data-md-component="logo">
      
  <img src="../../../hausrack-logo.png" alt="logo">

    </a>
    HAUSRACK
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/rebma-io/hausrack" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.5.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    rebma-io/hausrack
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Home
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../design/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Design
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Hardware
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Hardware
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../hardware/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Overview
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../hardware/mechanical/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Mechanical
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../hardware/wiring/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Wiring
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../hardware/datasheets/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Datasheets
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../software/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Software
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Project Updates
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../CHANGELOG/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Changelog
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
  <div class="md-content" data-md-component="content">
    <div class="md-content__inner">
      <header class="md-typeset">
        <h1 id="hardware">Hardware</h1>
      </header>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
      <nav class="md-post__authors md-typeset">
        
          <span class="md-author">
            <img src="https://github.com/petrilli.png" alt="Christopher Petrilli">
          </span>
        
      </nav>
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2024-08-24 00:00:00">August 24, 2024</time></li>
        
          <li class="md-meta__item">
            in
            
              <a href="./" class="md-meta__link">Hardware</a></li>
        
        
          
          <li class="md-meta__item">
            
              4 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="development-boards-to-go"><a class="toclink" href="../../2024/08/24/development-boards-to-go/">Development Boards to Go</a></h2>
<p>I have a somewhat long trip coming up, and I won't be taking my workshop
with me. Still, I want to be able to work on this project while I'm
traveling. The decision I came to was to build a couple of development
boards that are generic versions that I can use while I travel. I can
slot these into the backplane, and pack just a single 12V power supply.</p>
<h3 id="goals"><a class="toclink" href="../../2024/08/24/development-boards-to-go/#goals">Goals</a></h3>
<p>The project consists of two kinds of things: boards that slot into the
chassis and contain some amount of UI, and endpoints that affect the
world around them. I'm pretty sure I can build a single board and get
most of what I need from that via some I<sub>2</sub>C magic. The hope is that
this lets me have enough to work on <em>most</em> things while I'm away from
home without having to carry a lot of extra things with me.</p>
<h3 id="universal-card"><a class="toclink" href="../../2024/08/24/development-boards-to-go/#universal-card">Universal Card</a></h3>
<p>The card needs some basic components: </p>
<ul>
<li>DIN 41612 backplane connector to get power and send CAN-FD signals.</li>
<li>WeAct STM32G474 Long MCU module</li>
<li>Some status LEDs for LED.</li>
</ul>
<p>I'm planning to have the following I/O on the board:</p>
<ul>
<li>2 <a href="https://www.nidec-components.com/us/product/detail/00000326/">Nidec TM push
  buttons</a> 
  with built-in LED.</li>
<li>2 <a href="https://www.aliexpress.us/item/2251832782113850.html">PB86-A2 push
  buttons</a> with
  both red and green LEDs.</li>
<li>1 <a href="https://tech.alpsalpine.com/e/products/category/encorders/sub/01/series/ec11e/">Alps EC11 rotary
  encoder</a>.</li>
<li>1 small toggle switche.</li>
<li>1 <a href="https://www.mouser.com/c/passive-components/potentiometers-trimmers-rheostats/slide-potentiometers/?m=Alps%20Alpine">Alps Alpine slide
  potentiometer</a>.</li>
<li>3 red LED switched by a MOSFET.</li>
<li>3 green LED switched by MOSFET.</li>
<li>4 <a href="http://world-semi.com/ws2812-family/">WS2812B</a> RGB LED.</li>
<li>4 digit 7-segment display, driven by a
  <a href="https://www.analog.com/en/products/MAX7219.html">MAX7219</a>.</li>
<li>1 3.3V I/O for driving a relay board. This will come out on a JST PH
  connector. See below.</li>
<li>General I<sub>2</sub>C bus on an JST PH (SH?) compatible with <a href="https://learn.adafruit.com/introducing-adafruit-stemma-qt/what-is-stemma">Adafruit
  STEMMA</a>.</li>
<li>CAN-FD using a <a href="">TCAN1057</a> tranceiver and <a href="">ESD2CANFD</a> ESD
  protection on the backplane and JST PH connector. The connector can be
  used for termination.</li>
</ul>
<p>For 1 each of the buttons, I'll use a physical debounce (discussed
below). For the other, I'll do it in software. Let's see how that plays
out. </p>
<p>In addition, because the card is fed with 5V from the backplane, we'll
need a 3.3V LDO regulator, probably a 1117-style in fixed output.</p>
<h3 id="relay-card"><a class="toclink" href="../../2024/08/24/development-boards-to-go/#relay-card">Relay Card</a></h3>
<p>The relay card is going to be a bit more "interesting" in a lot of
ways. Because I want to be able to (potentially) handle mains voltage
(110-120VAC in the US), I have to be careful and take quite a few
precautions.</p>
<p>The board will have an AC relay (<a href="https://components.omron.com/us-en/products/relays/G2RL">Omron G2RL-1A-E-ASI
DC5</a>) driven
via a <a href="https://www.diodes.com/part/view/DRDC3105F/">DRDC3105F</a>. Power in
will come via an
<a href="https://en.wikipedia.org/wiki/IEC_60320#C13/C14_coupler">C13</a> connector
and provided out through a NEMA 5-15 receptacle. </p>
<h3 id="physical-debounce"><a class="toclink" href="../../2024/08/24/development-boards-to-go/#physical-debounce">Physical Debounce</a></h3>
<p>While it's possible to do debounce in software, and quite common today
to do that with the surfeit of CPU cycles most people have available, I
feel like seeing what it would be like to use a physical debounce
circuit. First, what the heck is switch bouncing and why do you need to
debounce it? I'm gonna borrow some diagrams from <a href="https://www.digikey.com/en/articles/how-to-implement-hardware-debounce-for-switches-and-relays">this
article</a>
to tell the story. </p>
<p>First, let's take a look at what it looks like without debouncing on a
normal SPST switch:</p>
<p><img alt="Image showing both a switch with a pull-up resistor, and the behavior
of it with both clean and dirty bounces" src="../../img/debounce-no-circuit.jpg" /></p>
<p>You can see how, due to the mechanical nature of the switch, there can
be some bouncing of the output, even with a pull-up resistor. Now, let's
take a look at it when you add an RC circuit:</p>
<p><img alt="Switch shown with an RC circuit on the output, and charts showing the
discharge and charge cycle" src="../../img/debounce-rc-circuit.jpg" /></p>
<p>Here we use an RC circuit where the resistor controls the charge and
discharge of the capacitor, and a <a href="https://en.wikipedia.org/wiki/Schmitt_trigger">Schmitt
trigger</a> to ensure that
we get a clean transition. The general guidance is that 20ms is plenty
of time for the switch to settle, so if we aim for a 20ms time constant
(&tau;) on the RC circuit, we get:</p>
<div class="arithmatex">\[\begin{align}
\tau &amp; = R\times C \\
     &amp; = 100K \times 220nF \\
     &amp; = 0.022 
\end{align}\]</div>
<p>Close enough for Seattle.</p>
<p>For the Schmitt trigger, I'm just going to use a
<a href="https://octopart.com/search?q=74LVC1G14&amp;currency=USD&amp;specs=0">74LVC1G14</a>
which are available in a small SOT package.</p>
<p>For the SPDT switch, however, I want to use an alternate strategy based
on NAND gates in an SR latch configuration. The Cadillac of debounce, as
it were. </p>
<p><img alt="Debounce circuit showing an SPDT switch connected to a dual NAND
gate" src="../../img/debounce-nand-circuit.jpg" /></p>
<p>For the NAND gate, I'm going to use the basic
<a href="https://octopart.com/search?q=74HC00&amp;currency=USD&amp;specs=0">74HC00</a>,
which unfortunately in the form I have is in an SOIC-14 package. But I
paid less than $0.09 each, so who is complaining?</p>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
      <nav class="md-post__authors md-typeset">
        
          <span class="md-author">
            <img src="https://github.com/petrilli.png" alt="Christopher Petrilli">
          </span>
        
      </nav>
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2024-08-16 00:00:00">August 16, 2024</time></li>
        
          <li class="md-meta__item">
            in
            
              <a href="./" class="md-meta__link">Hardware</a>, 
              <a href="../software/" class="md-meta__link">Software</a></li>
        
        
          
          <li class="md-meta__item">
            
              17 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="a-new-board-is-born"><a class="toclink" href="../../2024/08/16/a-new-board-is-born/">A New Board is Born</a></h2>
<div class="admonition info">
<p class="admonition-title">Where Have You Been?</p>
<p>The short answer is "around", but the real answer is more
complicated. Due to :gestures at world:, I haven't really been
mentally in a place where I can spend time working on things like
this project. After a few months of just zoning out, I've realized I
need the structure of a project to keep me focused, and so I'm
trying to pick back up where I left off.</p>
</div>
<p><img align="right" alt="A long PCB is inserted into a
protoboard" src="../../img/weact-stm32g474-long.jpg" width="300" />
When last we talked, I was talking about a modular base board built
around an STM32H5, but I realized that there was another alternative ...
build it around an existing board. So, that's my plan now. This removes
a lot of design work, yes, but at least for the initial design, it lets
me focus on some other things. I've chosen to use a board from WeAct
Studio. These are the people behind the famous Blue Pill and Black Pill
STM32 boards. They also make one built around an
<a href="https://github.com/WeActStudio/WeActStudio.STM32G474CoreBoard">STM32G474CEU6</a>,
which is a 170MHz ARM Cortex-M4 with 128KB of RAM, 512KB of Flash, and
2 CAN-FD buses available. It's in a somewhat long 48-pin package. If you
want to buy one, you can find them on your neighborhood massive Chinese
marketplace. </p>
<p>Since I'm planning to write all the software on top of
<a href="http://zephyrproject.org">Zephyr</a>, and this board isn't in their
already <a href="https://docs.zephyrproject.org/latest/boards/index.html">extensive list of
boards</a>, I
needed to add it to that. So, into the breach we go.</p>
<p>First, I <a href="https://docs.zephyrproject.org/latest/hardware/porting/board_porting.html">read the
documentation</a>.
Since the SOC is supported already thanks to a ton of work from
STMicroelectronics, it really just meant customizing for this specific
instance on this board. To do that, I needed to name the board, and then
create a bunch of files. The name I chose was <code>stm32g474_long</code> under the
<code>weact</code>
<a href="https://github.com/zephyrproject-rtos/zephyr/blob/main/dts/bindings/vendor-prefixes.txt">vendor</a>
directory. Those files are:</p>
<dl>
<dt><code>board.yml</code></dt>
<dd>
<p>a YAML file describing the high-level meta data of the boards such
as the boards names and the SOC. </p>
</dd>
<dt><code>weact_stm32h474_long.dts</code></dt>
<dd>
<p>The hardware description in devicetree format. This declares your SOC,
connectors, and any other hardware components such as LEDs, buttons,
sensors, or communication peripherals (USB, etc).</p>
</dd>
<dt><code>Kconfig.weact_stm32h474_long</code></dt>
<dd>
<p>This is the base software configuration for selecting SOC and other
board and SOC related settings. Kconfig settings outside of the
board and SOC tree must  not be selected. To select general Zephyr
Kconfig settings the Kconfig file must be used.</p>
</dd>
<dt><code>board.cmake</code></dt>
<dd>
<p>Provides information on flashing and debugging the board</p>
</dd>
<dt><code>weact_stm32h474_long.yaml</code></dt>
<dd>
<p>A bunch of metadata that's mostly used by the test runner to help
understand what tests to run. Note, I don't know why this one ends
in <code>yaml</code>, but the other in <code>yml</code>, nor whether it matters, but I
just copied the style in the documentation.</p>
</dd>
<dt><code>weact_stm32h474_long_defconfig</code></dt>
<dd>
<p>Some Kconfig-style presets for building any application. These can
be overridden in the application.</p>
</dd>
</dl>
<p>Rather than start from a clean slate, I actually decided to "borrow"
some of the already made board configs from an existing WeAct board, the
<a href="https://github.com/zephyrproject-rtos/zephyr/tree/main/boards/weact/stm32g431_core">STM32G431</a>
model. This gave me a good head start on what I needed to do.</p>
<p>So let's go through the files. I hope my explanations are both
reasonably accurate and passably consumable. I'm learning this as I go
along, and so this is just my current knowledge.</p>
<h3 id="boardyml"><a class="toclink" href="../../2024/08/16/a-new-board-is-born/#boardyml">board.yml</a></h3>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nt">board</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">weact_stm32g474_long</span>
<span class="w">  </span><span class="nt">vendor</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">weact</span>
<span class="w">  </span><span class="nt">socs</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">stm32g474xx</span>
</code></pre></div></td></tr></table></div>
<p>This is pretty obvious, but the name of the SOC (line 5) is something
you have to find in the <a href="https://github.com/zephyrproject-rtos/zephyr/tree/main/soc">existing
repository</a>.
Some of the naming isn't necessarily obvious to me, but it was pretty
easy to figure out. Once you get to the right <a href="https://github.com/zephyrproject-rtos/zephyr/tree/main/soc/st/stm32/stm32g4xx">processor
family</a>
it's not too bad.</p>
<h3 id="weact_stm32h474_longdts"><a class="toclink" href="../../2024/08/16/a-new-board-is-born/#weact_stm32h474_longdts">weact_stm32h474_long.dts</a></h3>
<p>This is the biggest of all of them, so let's take it from the top (post
copyright). First, this is a
<a href="https://docs.zephyrproject.org/latest/build/dts/index.html#dt-guide">devicetree</a>
format, which is also used Linux.  I can't say as I consider myself to
<em>know</em> it yet, but I've started to get a feel for it. I've elided empty
lines along the way.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="w"> </span><span class="cp">/dts-v1/</span><span class="p">;</span>
<span class="w"> </span><span class="cp">#include</span><span class="cm"> </span><span class="cpf">&lt;st/g4/stm32g474Xe.dtsi&gt;</span>
<span class="w"> </span><span class="cp">#include</span><span class="cm"> </span><span class="cpf">&lt;st/g4/stm32g474r(b-c-e)tx-pinctrl.dtsi&gt;</span>
<span class="w"> </span><span class="cp">#include</span><span class="cm"> </span><span class="cpf">&lt;zephyr/dt-bindings/input/input-event-codes.h&gt;</span>
</code></pre></div></td></tr></table></div>
<p>First, we set the version of the DTS (devicetree) schema that's in use,
then we include some existing files to set up some presets. </p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="w"> </span><span class="nf">/</span><span class="cm"> </span><span class="p">{</span>
<span class="w">     </span><span class="kr">model</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;WeAct STM32G474CEU6 Long board&quot;</span><span class="p">;</span>
<span class="w">     </span><span class="kr">compatible</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;weact,stm32g474_long&quot;</span><span class="p">;</span>

<span class="w">     </span><span class="nf">chosen</span><span class="cm"> </span><span class="p">{</span>
<span class="w">         </span><span class="n">zephyr</span><span class="p">,</span><span class="n">console</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">lpuart1</span><span class="p">;</span>
<span class="w">         </span><span class="n">zephyr</span><span class="p">,</span><span class="n">shell-uart</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">lpuart1</span><span class="p">;</span>
<span class="w">         </span><span class="n">zephyr</span><span class="p">,</span><span class="n">sram</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">sram0</span><span class="p">;</span>
<span class="w">         </span><span class="n">zephyr</span><span class="p">,</span><span class="n">flash</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">flash0</span><span class="p">;</span>
<span class="w">         </span><span class="n">zephyr</span><span class="p">,</span><span class="n">canbus</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">fdcan2</span><span class="p">;</span>
<span class="w">         </span><span class="n">zephyr</span><span class="p">,</span><span class="n">code-partition</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">slot0_partition</span><span class="p">;</span>
<span class="w">     </span><span class="p">};</span>
</code></pre></div></td></tr></table></div>
<p>The first thing to know is that the start of line 12 is the start of the
definition of a node, in this case the root (<code>/</code>) node. Like most
languages, everything inside the curly brackets is part of that
definition.</p>
<p>The <code>/chosen</code> node sets up some defaults. For example, line 17 says that
the node <code>lpuart1</code> is the default Zephyr console. The <code>&amp;</code> is used a lot
like C to grab the "address of" something else. They're called
<a href="https://docs.zephyrproject.org/latest/build/dts/phandles.html">phandles</a>.
In this case, <code>lpuart1</code> is the <a href="https://www.st.com/resource/en/product_training/stm32l4_peripheral_lpuart.pdf">low power
UART</a>.
Low power means it can function in low power mode when the low-speed
(32.768KHz) clock is in effect. It is, however, limited to 9600bps at
that time.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="w">     </span><span class="nf">leds</span><span class="cm"> </span><span class="p">{</span>
<span class="w">         </span><span class="kr">compatible</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;gpio-leds&quot;</span><span class="p">;</span>
<span class="w">         </span><span class="nl">blue_led</span><span class="p">:</span><span class="w"> </span><span class="nf">led_0</span><span class="cm"> </span><span class="p">{</span>
<span class="w">             </span><span class="n">gpios</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;&amp;</span><span class="na">gpioc</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="na">GPIO_ACTIVE_HIGH</span><span class="o">&gt;</span><span class="p">;</span>
<span class="w">             </span><span class="n">label</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;User LED&quot;</span><span class="p">;</span>
<span class="w">         </span><span class="p">};</span>
<span class="w">     </span><span class="p">};</span>
</code></pre></div></td></tr></table></div>
<p>First we set up the on-board LED, in this case, an annoying blue one.
Walking through this, line 25 creates the <code>/leds</code> node to contain all
the LEDs on the board. It then says it's compatible with the <code>gpio-leds</code>
hardware feature, and creates a specific instance <code>/leds/led_0</code> that
also has an label with a different name, <code>/leds/blue_led</code> (line 27). On
line 28 it sets up the GPIO pins for that LED. Since the LED is attached
to pin PC6, we know that it's part of the C cluster of GPIO pins
(<code>&amp;gpioc</code>), and then pin #6 in that cluster.  Finally, we tell it that
the pin is considered active, when it's high. Zephyr can tell the
difference between active high and active low pins. The <code>&lt;&gt;</code> defines an
array, here with 3 elements.</p>
<p>Note we are referencing phandles that are defined outside of our file
and have been brought in via the earlier includes.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="w">     </span><span class="nf">pwmleds</span><span class="cm"> </span><span class="p">{</span>
<span class="w">         </span><span class="kr">compatible</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;pwm-leds&quot;</span><span class="p">;</span>

<span class="w">         </span><span class="nf">blue_pwm_led</span><span class="cm"> </span><span class="p">{</span>
<span class="w">             </span><span class="n">pwms</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;&amp;</span><span class="na">pwm3</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="na">PWM_MSEC</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="w"> </span><span class="na">PWM_POLARITY_NORMAL</span><span class="o">&gt;</span><span class="p">;</span>
<span class="w">         </span><span class="p">};</span>
<span class="w">     </span><span class="p">};</span>
</code></pre></div></td></tr></table></div>
<p>Next, what's an LED that you can't dim? Useless, that's what!</p>
<p>So, as above, we explain that it's compatible with the <code>pwm-leds</code>
feature, and name the node <code>/pwmleds/blue_pwm_led</code>. We then have to set
up the timer that specifically drives the pulse-width modulated (PWM)
signal. </p>
<div class="admonition note">
<p class="admonition-title">The hidden world of timers</p>
<p>This is hidden in things like Arduino, but in Zephyr and most
other embedded systems, you have to know which timers are able to be 
connected to which GPIO pins. This is often considered an "alternate
function" of the pin. On STM32 there are multiple times, and each
timer can have multiple "channels". There's various restrictions on
them, but that's a topic for another time.</p>
</div>
<p>Here, we say this PWM is on channel 1 of timer 3, with a nominal period
of 20ms, and "normal" polarity, meaning it's active high.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="w">     </span><span class="nf">gpio_keys</span><span class="cm"> </span><span class="p">{</span>
<span class="w">         </span><span class="kr">compatible</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;gpio-keys&quot;</span><span class="p">;</span>
<span class="w">         </span><span class="nl">user_button</span><span class="p">:</span><span class="w"> </span><span class="nf">button</span><span class="cm"> </span><span class="p">{</span>
<span class="w">             </span><span class="n">label</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;User&quot;</span><span class="p">;</span>
<span class="w">             </span><span class="n">gpios</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;&amp;</span><span class="na">gpioc</span><span class="w"> </span><span class="mi">13</span><span class="w"> </span><span class="na">GPIO_ACTIVE_LOW</span><span class="o">&gt;</span><span class="p">;</span>
<span class="w">             </span><span class="n">zephyr</span><span class="p">,</span><span class="n">code</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="na">INPUT_KEY_0</span><span class="o">&gt;</span><span class="p">;</span>
<span class="w">         </span><span class="p">};</span>
<span class="w">     </span><span class="p">};</span>
</code></pre></div></td></tr></table></div>
<p>Now we define some fancy "keys". This is part of the
<a href="https://docs.zephyrproject.org/latest/build/dts/api/bindings/input/gpio-keys.html">gpio-keys</a>
feature, which allows you to map GPIO pins into a set of input events,
rather than just GPIO events. Think of it as mapping the keys on a
keyboard. There are other <a href="https://docs.zephyrproject.org/latest/build/dts/api/bindings/input/input-keymap.html">more
advanced</a>
options for key matrices. The properties are similar to earlier, except
this button is active when it's low (pulled to ground), and then we say
that it emits <code>0</code> into the input stream when pressed.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="w">     </span><span class="nf">aliases</span><span class="cm"> </span><span class="p">{</span>
<span class="w">         </span><span class="n">led0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">blue_led</span><span class="p">;</span>
<span class="w">         </span><span class="n">mcuboot-led0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">blue_led</span><span class="p">;</span>
<span class="w">         </span><span class="n">pwm-led0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">blue_pwm_led</span><span class="p">;</span>
<span class="w">         </span><span class="n">sw0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">user_button</span><span class="p">;</span>
<span class="w">         </span><span class="n">watchdog0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">iwdg</span><span class="p">;</span>
<span class="w">         </span><span class="n">die-temp0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">die_temp</span><span class="p">;</span>
<span class="w">         </span><span class="n">volt-sensor0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">vref</span><span class="p">;</span>
<span class="w">         </span><span class="n">volt-sensor1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">vbat</span><span class="p">;</span>
<span class="w">     </span><span class="p">};</span>
<span class="w"> </span><span class="p">};</span>
</code></pre></div></td></tr></table></div>
<p>Here we set up a bunch of aliases that can be used to refer to things.
These work exactly like any other phandle, so referencing <code>&amp;led0</code> is the
same as referencing <code>&amp;blue_led</code>.</p>
<p>Now comes the beast of a thing .. the clock tree. This is something that
if you've never worked low-level (below Arduino, for example), you're
probably completely unfamiliar with. There are multiple clock sources,
phase-locked loops, and derivative clocks that drive everything. There's
an <a href="https://community.st.com/t5/stm32-mcus/part-1-introduction-to-the-stm32-microcontroller-clock-system/ta-p/605369">excellent
tutorial</a>
on the STM32 support forum. </p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="w"> </span><span class="o">&amp;</span><span class="na">clk_lsi</span><span class="w"> </span><span class="p">{</span>
<span class="w">     </span><span class="kr">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;okay&quot;</span><span class="p">;</span>
<span class="w"> </span><span class="p">};</span>
</code></pre></div></td></tr></table></div>
<p>Here we just tell Zephyr that the low-speed internal clock is "okay",
meaning you can use it. You'll see this notation somewhat frequently.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="w"> </span><span class="o">&amp;</span><span class="na">clk_hsi48</span><span class="w"> </span><span class="p">{</span>
<span class="w">     </span><span class="kr">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;okay&quot;</span><span class="p">;</span>
<span class="w"> </span><span class="p">};</span>
</code></pre></div></td></tr></table></div>
<p>Here we do the same thing for the high-speed internal clock, which runs
at 48MHz.</p>
<p><div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="w"> </span><span class="o">&amp;</span><span class="na">clk_hse</span><span class="w"> </span><span class="p">{</span>
<span class="w">     </span><span class="n">clock-frequency</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="na">DT_FREQ_M</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="o">&gt;</span><span class="p">;</span>
<span class="w">     </span><span class="kr">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;okay&quot;</span><span class="p">;</span>
<span class="w"> </span><span class="p">};</span>
</code></pre></div></td></tr></table></div>
<a name="clock-fun"></a>
Now here's where it gets interesting. Here we have to tell the system
what the high-speed <em>external</em> clock is. It just gets a repeated pulse
from the crystal, but it has no idea what that frequency is, so we tell
it that it's 8MHz.</p>
<p>I got this wrong initially as I misread the schematic, and it resulted
in some challenges. I like to use a <a href="../../2024/08/16/a-new-board-is-born/#blink-for-me-baby">LED blink
program</a> as the initial test because it sorts out
the clocks as well as GPIO, and when it was initially set to be a 1s
cycle, it was taking 3.something seconds. Something was off. </p>
<p>It turned out that I had both <code>clk_hse</code> and <code>pll</code> wrong. I had copied
them from another SOC which has a different target clock rate, and
different oscillator frequency. There was definitely some trial and
error to sort that out as I also had to make sure I <em>really</em> understood
the STM32 clock tree.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="w"> </span><span class="o">&amp;</span><span class="na">pll</span><span class="w"> </span><span class="p">{</span>
<span class="w">     </span><span class="n">div-m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mi">2</span><span class="o">&gt;</span><span class="p">;</span>
<span class="w">     </span><span class="n">mul-n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mi">85</span><span class="o">&gt;</span><span class="p">;</span>
<span class="w">     </span><span class="n">div-p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mi">2</span><span class="o">&gt;</span><span class="p">;</span>
<span class="w">     </span><span class="n">div-q</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mi">2</span><span class="o">&gt;</span><span class="p">;</span>
<span class="w">     </span><span class="n">div-r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mi">2</span><span class="o">&gt;</span><span class="p">;</span>
<span class="w">     </span><span class="n">clocks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;&amp;</span><span class="na">clk_hse</span><span class="o">&gt;</span><span class="p">;</span>
<span class="w">     </span><span class="kr">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;okay&quot;</span><span class="p">;</span>
<span class="w"> </span><span class="p">};</span>
</code></pre></div></td></tr></table></div>
<p>One of the first things that is done is to use a <a href="https://en.wikipedia.org/wiki/Phase-locked_loop">phase-locked
loop</a> to create a
derivative highly accurate clock signal from the input. We tell it that
we want to use <code>&amp;clk_hse</code> we just defined as the source (there's another
separate thing going on for the low-speed clock that's out of scope
here). Then we have to provide all the multipliers and divisors that it
needs to generate the output clock, which are documented in the chip
reference manual, but also some information is in <a href="https://community.st.com/t5/stm32-mcus/how-to-use-stm32cubemx-to-configure-hse-high-speed-external/ta-p/49604">this
post</a>.
The best way to get these is to use
<a href="https://www.st.com/en/development-tools/stm32cubemx.html">STM32CubeMX</a>
and its clock solver to get it all right. </p>
<p>To get an idea of how complex the clock system is, here's a quick
screenshot of the clock configuration section of the app:</p>
<p><img alt="A screenshot from STM32CubeMX's clock configuration screen" src="../../img/stm32cubemx-clocks.jpg" /></p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span>
<span class="normal">89</span>
<span class="normal">90</span>
<span class="normal">91</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="w"> </span><span class="o">&amp;</span><span class="na">rcc</span><span class="w"> </span><span class="p">{</span>
<span class="w">     </span><span class="n">clocks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;&amp;</span><span class="na">pll</span><span class="o">&gt;</span><span class="p">;</span>
<span class="w">     </span><span class="n">clock-frequency</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="na">DT_FREQ_M</span><span class="p">(</span><span class="mi">170</span><span class="p">)</span><span class="o">&gt;</span><span class="p">;</span>
<span class="w">     </span><span class="n">ahb-prescaler</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mi">1</span><span class="o">&gt;</span><span class="p">;</span>
<span class="w">     </span><span class="n">apb1-prescaler</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mi">1</span><span class="o">&gt;</span><span class="p">;</span>
<span class="w">     </span><span class="n">apb2-prescaler</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mi">1</span><span class="o">&gt;</span><span class="p">;</span>
<span class="w"> </span><span class="p">};</span>
</code></pre></div></td></tr></table></div>
<p>Here we configure the reset and clock control (RCC) circuit, which is
one of the main sources that distributes and times things across the
rest of the MCU. We tell it to get its source from the PLL, and that the
target frequency is 170MHz. We then provide any scalers needed for the
various buses inside the MCU.</p>
<div class="admonition note">
<p class="admonition-title">Why so many knobs?</p>
<p>You might ask, why is this so damned complicated? The main reason is
power management. If you're worrying about power consumption, say 
because you're battery powered, slower clocks use less power. A lot 
less. Being able to tune clocks across the system to only use the 
"minimum" clock to get the job done lets you seriously dial down the 
power consumption of the MCU.</p>
<p>In our case, we don't really care because everything in mains-powered, 
and we are only talking about milliamps. But in a battery-powered
system, you could reduce the power consumption by a factor of 5 or
more.</p>
</div>
<p><div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">93</span>
<span class="normal">94</span>
<span class="normal">95</span>
<span class="normal">96</span>
<span class="normal">97</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nl">zephyr_udc0</span><span class="p">:</span><span class="w"> </span><span class="o">&amp;</span><span class="na">usb</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">pinctrl-0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;&amp;</span><span class="na">usb_dm_pa11</span><span class="w"> </span><span class="o">&amp;</span><span class="na">usb_dp_pa12</span><span class="o">&gt;</span><span class="p">;</span>
<span class="w">    </span><span class="n">pinctrl-names</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;default&quot;</span><span class="p">;</span>
<span class="w">    </span><span class="kr">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;okay&quot;</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div></td></tr></table></div>
We now enter the heavy IO section of the devicetree, and we need to
start by talking about <a href="https://docs.zephyrproject.org/latest/hardware/pinctrl/index.html">pin
control</a>.
This is a deep topic, and is also specific to the individual MCU
architecture. Diving in, every GPIO (general purpose IO) pin has an
entire little active complex circuit inside it that not only drives it
but does a huge amount of configuration. Pin control is what decides if
the pin is just a regular IO pin, or if it's using an alternate function
(AF), like ADC or DAC. It determines if it's an input or output pin, if
it's pulled up or down, or left floating. It determines whether it's an
<a href="https://en.wikipedia.org/wiki/Open_collector">open drain</a> output or
configured in
<a href="https://en.wikipedia.org/wiki/Pushpull_output">push-pull</a>. It's a
whole collection of switches, resistors, and other components to let you
plop a value in an IO register and have it all magically reconfigure.
There's a great introduction to how all this works (in Linux, but it's
very much the same in Zephyr) in <a href="https://elinux.org/images/a/a7/ELC-2021_Introduction_to_pin_muxing_and_GPIO_control_under_Linux.pdf">this
presentation</a>.</p>
<p>Here we're creating a node <code>usb</code> on the phandles specifically for the
USB AF on pins PA11 and PA12 as the first (0<sup>th</sup>) configuration of pin
control, which in this case is labeled as "default" and marked as OK.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="o">&amp;</span><span class="na">usart1</span><span class="w"> </span><span class="p">{</span>
<span class="w">     </span><span class="n">pinctrl-0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;&amp;</span><span class="na">usart1_tx_pc4</span><span class="w"> </span><span class="o">&amp;</span><span class="na">usart1_rx_pc5</span><span class="o">&gt;</span><span class="p">;</span>
<span class="w">     </span><span class="n">pinctrl-names</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;default&quot;</span><span class="p">;</span>
<span class="w">     </span><span class="n">current-speed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mi">115200</span><span class="o">&gt;</span><span class="p">;</span>
<span class="w">     </span><span class="kr">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;okay&quot;</span><span class="p">;</span>
<span class="w"> </span><span class="p">};</span>

<span class="w"> </span><span class="o">&amp;</span><span class="na">lpuart1</span><span class="w"> </span><span class="p">{</span>
<span class="w">     </span><span class="n">pinctrl-0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;&amp;</span><span class="na">lpuart1_tx_pa2</span><span class="w"> </span><span class="o">&amp;</span><span class="na">lpuart1_rx_pa3</span><span class="o">&gt;</span><span class="p">;</span>
<span class="w">     </span><span class="n">pinctrl-1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;&amp;</span><span class="na">analog_pa2</span><span class="w"> </span><span class="o">&amp;</span><span class="na">analog_pa3</span><span class="o">&gt;</span><span class="p">;</span>
<span class="w">     </span><span class="n">pinctrl-names</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;default&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;sleep&quot;</span><span class="p">;</span>
<span class="w">     </span><span class="n">current-speed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mi">115200</span><span class="o">&gt;</span><span class="p">;</span>
<span class="w">     </span><span class="kr">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;okay&quot;</span><span class="p">;</span>
<span class="w"> </span><span class="p">};</span>
</code></pre></div></td></tr></table></div>
<p>Something similar is happening here, but in the <code>lpuart1</code> we have
something different. We have 2 different configurations (0, 1) with
different names (aliases basically) of "default" and "sleep". We're
saying that in the normal running mode, this is the TX and RX pins for
the low-power UART #1, but when the chip is asleep, it flips to a
regular analog I/O, which allows for easier wake-up.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="w"> </span><span class="o">&amp;</span><span class="na">i2c1</span><span class="w"> </span><span class="p">{</span>
<span class="w">     </span><span class="n">pinctrl-0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;&amp;</span><span class="na">i2c1_scl_pb8</span><span class="w"> </span><span class="o">&amp;</span><span class="na">i2c1_sda_pb9</span><span class="o">&gt;</span><span class="p">;</span>
<span class="w">     </span><span class="n">pinctrl-names</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;default&quot;</span><span class="p">;</span>
<span class="w">     </span><span class="kr">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;okay&quot;</span><span class="p">;</span>
<span class="w"> </span><span class="p">};</span>
</code></pre></div></td></tr></table></div>
<p>...</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="w"> </span><span class="o">&amp;</span><span class="na">spi1</span><span class="w"> </span><span class="p">{</span>
<span class="w">     </span><span class="n">pinctrl-0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;&amp;</span><span class="na">spi1_sck_pa5</span><span class="w"> </span><span class="o">&amp;</span><span class="na">spi1_miso_pa6</span><span class="w"> </span><span class="o">&amp;</span><span class="na">spi1_mosi_pa7</span><span class="o">&gt;</span><span class="p">;</span>
<span class="w">     </span><span class="n">pinctrl-names</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;default&quot;</span><span class="p">;</span>
<span class="w">     </span><span class="n">cs-gpios</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;&amp;</span><span class="na">gpiob</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="p">(</span><span class="na">GPIO_ACTIVE_LOW</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="na">GPIO_PULL_UP</span><span class="p">)</span><span class="o">&gt;</span><span class="p">;</span>
<span class="w">     </span><span class="kr">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;okay&quot;</span><span class="p">;</span>
<span class="w"> </span><span class="p">};</span>
</code></pre></div></td></tr></table></div>
<p>Here we're defining an
<a href="https://en.wikipedia.org/wiki/Serial_Peripheral_Interface">SPI</a> set of
pins. The <code>cs-gpios</code> defines the pin PB6 as the chip select line for the
SPI port, marks it as active when it's low, and then attaches a pull-up
resistor to it internally to hold it inactive by default.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="w"> </span><span class="o">&amp;</span><span class="na">spi2</span><span class="w"> </span><span class="p">{</span>
<span class="w">     </span><span class="n">pinctrl-0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;&amp;</span><span class="na">spi2_nss_pb12</span><span class="w"> </span><span class="o">&amp;</span><span class="na">spi2_sck_pb13</span>
<span class="w">              </span><span class="o">&amp;</span><span class="na">spi2_miso_pb14</span><span class="w"> </span><span class="o">&amp;</span><span class="na">spi2_mosi_pb15</span><span class="o">&gt;</span><span class="p">;</span>
<span class="w">     </span><span class="n">pinctrl-names</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;default&quot;</span><span class="p">;</span>
<span class="w">     </span><span class="kr">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;okay&quot;</span><span class="p">;</span>
<span class="w"> </span><span class="p">};</span>

<span class="w"> </span><span class="o">&amp;</span><span class="na">spi3</span><span class="w"> </span><span class="p">{</span>
<span class="w">     </span><span class="n">pinctrl-0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;&amp;</span><span class="na">spi3_nss_pa15</span><span class="w"> </span><span class="o">&amp;</span><span class="na">spi3_sck_pc10</span>
<span class="w">              </span><span class="o">&amp;</span><span class="na">spi3_miso_pc11</span><span class="w"> </span><span class="o">&amp;</span><span class="na">spi3_mosi_pc12</span><span class="o">&gt;</span><span class="p">;</span>
<span class="w">     </span><span class="n">pinctrl-names</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;default&quot;</span><span class="p">;</span>
<span class="w">     </span><span class="kr">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;okay&quot;</span><span class="p">;</span>
<span class="w"> </span><span class="p">};</span>
</code></pre></div></td></tr></table></div>
<p>More of the same here, but without the chip select defined yet. This can
be done in the user's code.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="w"> </span><span class="o">&amp;</span><span class="na">timers2</span><span class="w"> </span><span class="p">{</span>
<span class="w">     </span><span class="kr">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;okay&quot;</span><span class="p">;</span>

<span class="w">     </span><span class="nl">pwm2</span><span class="p">:</span><span class="w"> </span><span class="nf">pwm</span><span class="cm"> </span><span class="p">{</span>
<span class="w">         </span><span class="kr">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;okay&quot;</span><span class="p">;</span>
<span class="w">         </span><span class="n">pinctrl-0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;&amp;</span><span class="na">tim2_ch1_pa5</span><span class="o">&gt;</span><span class="p">;</span>
<span class="w">         </span><span class="n">pinctrl-names</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;default&quot;</span><span class="p">;</span>
<span class="w">     </span><span class="p">};</span>
<span class="w"> </span><span class="p">};</span>

<span class="w"> </span><span class="o">&amp;</span><span class="nf">timers3</span><span class="cm"> </span><span class="p">{</span>
<span class="w">     </span><span class="n">st</span><span class="p">,</span><span class="n">prescaler</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mi">10000</span><span class="o">&gt;</span><span class="p">;</span>
<span class="w">     </span><span class="kr">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;okay&quot;</span><span class="p">;</span>
<span class="w">     </span><span class="nl">pwm3</span><span class="p">:</span><span class="w"> </span><span class="nf">pwm</span><span class="cm"> </span><span class="p">{</span>
<span class="w">         </span><span class="kr">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;okay&quot;</span><span class="p">;</span>
<span class="w">         </span><span class="n">pinctrl-0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;&amp;</span><span class="na">tim3_ch1_pb4</span><span class="o">&gt;</span><span class="p">;</span>
<span class="w">         </span><span class="n">pinctrl-names</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;default&quot;</span><span class="p">;</span>
<span class="w">     </span><span class="p">};</span>
<span class="w"> </span><span class="p">};</span>

<span class="w"> </span><span class="nl">stm32_lp_tick_source</span><span class="p">:</span><span class="w"> </span><span class="o">&amp;</span><span class="nf">lptim1</span><span class="cm"> </span><span class="p">{</span>
<span class="w">     </span><span class="n">clocks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;&amp;</span><span class="na">rcc</span><span class="w"> </span><span class="na">STM32_CLOCK_BUS_APB1</span><span class="w"> </span><span class="mh">0x80000000</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">         </span><span class="o">&lt;&amp;</span><span class="na">rcc</span><span class="w"> </span><span class="na">STM32_SRC_LSI</span><span class="w"> </span><span class="na">LPTIM1_SEL</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">&gt;</span><span class="p">;</span>
<span class="w">     </span><span class="kr">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;okay&quot;</span><span class="p">;</span>
<span class="w"> </span><span class="p">};</span>
</code></pre></div></td></tr></table></div>
<p>We need to set up our timers, and we configure them for use as PWM
timers as well. The <code>st,prescaler</code> is an STM32-specific property that
says that the timer should be "scaled" down by 1000x. </p>
<p>We also define a low-power tick source leveraging the low-power timer #1. 
Unfortunately, I don't actually understand the <code>clocks</code> property and
copied it from another definition. <em>I have no idea if it works</em>.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="w"> </span><span class="o">&amp;</span><span class="na">rtc</span><span class="w"> </span><span class="p">{</span>
<span class="w">     </span><span class="n">clocks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;&amp;</span><span class="na">rcc</span><span class="w"> </span><span class="na">STM32_CLOCK_BUS_APB1</span><span class="w"> </span><span class="mh">0x00000400</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">          </span><span class="o">&lt;&amp;</span><span class="na">rcc</span><span class="w"> </span><span class="na">STM32_SRC_LSI</span><span class="w"> </span><span class="na">RTC_SEL</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">&gt;</span><span class="p">;</span>
<span class="w">     </span><span class="kr">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;okay&quot;</span><span class="p">;</span>
<span class="w"> </span><span class="p">};</span>
</code></pre></div></td></tr></table></div>
<p>The STM32 has a real-time clock (RTC) that keeps a time and date
running as long as it's not in the most aggressive sleep state. Again,
copied, because the <code>clocks</code> property escapes my understanding and
searching.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="w"> </span><span class="o">&amp;</span><span class="na">flash0</span><span class="w"> </span><span class="p">{</span>
<span class="w">     </span><span class="na">partitions</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="kr">compatible</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;fixed-partitions&quot;</span><span class="p">;</span>
<span class="w">         </span><span class="kr">#address-cells</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mi">1</span><span class="o">&gt;</span><span class="p">;</span>
<span class="w">         </span><span class="kr">#size-cells</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mi">1</span><span class="o">&gt;</span><span class="p">;</span>

<span class="w">         </span><span class="nl">boot_partition</span><span class="p">:</span><span class="w"> </span><span class="nf">partition</span><span class="o">@</span><span class="mi">0</span><span class="cm"> </span><span class="p">{</span>
<span class="w">             </span><span class="n">label</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;mcuboot&quot;</span><span class="p">;</span>
<span class="w">             </span><span class="kr">reg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mh">0x00000000</span><span class="w"> </span><span class="na">DT_SIZE_K</span><span class="p">(</span><span class="mi">34</span><span class="p">)</span><span class="o">&gt;</span><span class="p">;</span>
<span class="w">         </span><span class="p">};</span>
<span class="w">         </span><span class="nl">slot0_partition</span><span class="p">:</span><span class="w"> </span><span class="nf">partition</span><span class="o">@</span><span class="mi">8800</span><span class="cm"> </span><span class="p">{</span>
<span class="w">             </span><span class="n">label</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;image-0&quot;</span><span class="p">;</span>
<span class="w">             </span><span class="kr">reg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mh">0x00008800</span><span class="w"> </span><span class="na">DT_SIZE_K</span><span class="p">(</span><span class="mi">240</span><span class="p">)</span><span class="o">&gt;</span><span class="p">;</span>
<span class="w">         </span><span class="p">};</span>
<span class="w">         </span><span class="nl">slot1_partition</span><span class="p">:</span><span class="w"> </span><span class="nf">partition</span><span class="o">@</span><span class="mi">44800</span><span class="cm"> </span><span class="p">{</span>
<span class="w">             </span><span class="n">label</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;image-1&quot;</span><span class="p">;</span>
<span class="w">             </span><span class="kr">reg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mh">0x00044800</span><span class="w"> </span><span class="na">DT_SIZE_K</span><span class="p">(</span><span class="mi">234</span><span class="p">)</span><span class="o">&gt;</span><span class="p">;</span>
<span class="w">         </span><span class="p">};</span>
<span class="w">         </span><span class="cm">/* Set 4Kb of storage at the end of the 512Kb of flash */</span>
<span class="w">         </span><span class="nl">storage_partition</span><span class="p">:</span><span class="w"> </span><span class="nf">partition</span><span class="o">@</span><span class="mi">7f000</span><span class="cm"> </span><span class="p">{</span>
<span class="w">             </span><span class="n">label</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;storage&quot;</span><span class="p">;</span>
<span class="w">             </span><span class="kr">reg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mh">0x0007f000</span><span class="w"> </span><span class="na">DT_SIZE_K</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">&gt;</span><span class="p">;</span>
<span class="w">         </span><span class="p">};</span>
<span class="w">     </span><span class="p">};</span>
<span class="w"> </span><span class="p">};</span>
</code></pre></div></td></tr></table></div>
<p>We need to break the flash storage into a few pieces here. We define 4
partitions for the boot loader, two versions of the code, and a 4Kb
storage area that you could lay a filesystem abstraction on top of, or
just store things directly into. </p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="w"> </span><span class="o">&amp;</span><span class="na">iwdg</span><span class="w"> </span><span class="p">{</span>
<span class="w">     </span><span class="kr">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;okay&quot;</span><span class="p">;</span>
<span class="w"> </span><span class="p">};</span>

<span class="w"> </span><span class="o">&amp;</span><span class="na">rng</span><span class="w"> </span><span class="p">{</span>
<span class="w">     </span><span class="kr">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;okay&quot;</span><span class="p">;</span>
<span class="w"> </span><span class="p">};</span>

<span class="w"> </span><span class="o">&amp;</span><span class="na">die_temp</span><span class="w"> </span><span class="p">{</span>
<span class="w">     </span><span class="kr">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;okay&quot;</span><span class="p">;</span>
<span class="w"> </span><span class="p">};</span>
</code></pre></div></td></tr></table></div>
<p>Just a few peripherals, the watchdog timer (<code>iwdg</code>), random number
generator (<code>rng</code>), and die temperature sensor (<code>die_temp</code>). We simply
mark them as available and ready.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="w"> </span><span class="o">&amp;</span><span class="na">adc1</span><span class="w"> </span><span class="p">{</span>
<span class="w">     </span><span class="n">pinctrl-0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;&amp;</span><span class="na">adc1_in1_pa0</span><span class="o">&gt;</span><span class="p">;</span>
<span class="w">     </span><span class="n">pinctrl-names</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;default&quot;</span><span class="p">;</span>
<span class="w">     </span><span class="n">st</span><span class="p">,</span><span class="n">adc-clock-source</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="na">SYNC</span><span class="o">&gt;</span><span class="p">;</span>
<span class="w">     </span><span class="n">st</span><span class="p">,</span><span class="n">adc-prescaler</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mi">4</span><span class="o">&gt;</span><span class="p">;</span>
<span class="w">     </span><span class="kr">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;okay&quot;</span><span class="p">;</span>
<span class="w"> </span><span class="p">};</span>

<span class="w"> </span><span class="o">&amp;</span><span class="na">dac1</span><span class="w"> </span><span class="p">{</span>
<span class="w">     </span><span class="n">pinctrl-0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;&amp;</span><span class="na">dac1_out1_pa4</span><span class="o">&gt;</span><span class="p">;</span>
<span class="w">     </span><span class="n">pinctrl-names</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;default&quot;</span><span class="p">;</span>
<span class="w">     </span><span class="kr">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;okay&quot;</span><span class="p">;</span>
<span class="w"> </span><span class="p">};</span>
</code></pre></div></td></tr></table></div>
<p>We wire up pin PA0 to ADC #1 channel 1. We tie it to the APB bus clock
(<code>st,adc-clock-source</code>), rather than letting it be independent, and then
we scale it down by a factor of 4 (<code>st,adc-prescaler</code>).</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="w"> </span><span class="o">&amp;</span><span class="na">fdcan1</span><span class="w"> </span><span class="p">{</span>
<span class="w">     </span><span class="n">clocks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;&amp;</span><span class="na">rcc</span><span class="w"> </span><span class="na">STM32_CLOCK_BUS_APB1</span><span class="w"> </span><span class="mh">0x02000000</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">          </span><span class="o">&lt;&amp;</span><span class="na">rcc</span><span class="w"> </span><span class="na">STM32_SRC_HSE</span><span class="w"> </span><span class="na">FDCAN_SEL</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">&gt;</span><span class="p">;</span>
<span class="w">     </span><span class="n">pinctrl-0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;&amp;</span><span class="na">fdcan1_rx_pa11</span><span class="w"> </span><span class="o">&amp;</span><span class="na">fdcan1_tx_pa12</span><span class="o">&gt;</span><span class="p">;</span>
<span class="w">     </span><span class="n">pinctrl-names</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;default&quot;</span><span class="p">;</span>
<span class="w">     </span><span class="kr">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;okay&quot;</span><span class="p">;</span>
<span class="w"> </span><span class="p">};</span>

<span class="w"> </span><span class="o">&amp;</span><span class="na">fdcan2</span><span class="w"> </span><span class="p">{</span>
<span class="w">     </span><span class="n">clocks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;&amp;</span><span class="na">rcc</span><span class="w"> </span><span class="na">STM32_CLOCK_BUS_APB1</span><span class="w"> </span><span class="mh">0x02000000</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">              </span><span class="o">&lt;&amp;</span><span class="na">rcc</span><span class="w"> </span><span class="na">STM32_SRC_HSE</span><span class="w"> </span><span class="na">FDCAN_SEL</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">&gt;</span><span class="p">;</span>
<span class="w">     </span><span class="n">pinctrl-0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;&amp;</span><span class="na">fdcan2_rx_pb12</span><span class="w"> </span><span class="o">&amp;</span><span class="na">fdcan2_tx_pb13</span><span class="o">&gt;</span><span class="p">;</span>
<span class="w">     </span><span class="n">pinctrl-names</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;default&quot;</span><span class="p">;</span>
<span class="w">     </span><span class="kr">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;okay&quot;</span><span class="p">;</span>
<span class="w"> </span><span class="p">};</span>
</code></pre></div></td></tr></table></div>
<p>The STM3G474 has 3 CAN-FD (or is it FDCAN? I see it written both ways),
and so we configure two of them.  At this point, this should be mostly
understandable. </p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="w"> </span><span class="o">&amp;</span><span class="na">vref</span><span class="w"> </span><span class="p">{</span>
<span class="w">     </span><span class="kr">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;okay&quot;</span><span class="p">;</span>
<span class="w"> </span><span class="p">};</span>

<span class="w"> </span><span class="o">&amp;</span><span class="na">vbat</span><span class="w"> </span><span class="p">{</span>
<span class="w">     </span><span class="kr">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;okay&quot;</span><span class="p">;</span>
<span class="w"> </span><span class="p">};</span>
</code></pre></div></td></tr></table></div>
<p>And finally, we enable the VREF+ and VBAT nodes on the chip. This allows
them to be measured with the ADC.</p>
<h3 id="kconfigweact_stm32h474_long"><a class="toclink" href="../../2024/08/16/a-new-board-is-born/#kconfigweact_stm32h474_long">Kconfig.weact_stm32h474_long</a></h3>
<p><div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">config</span><span class="w"> </span>BOARD_WEACT_STM32G474_LONG
<span class="w">    </span><span class="k">select</span><span class="w"> </span>SOC_STM32G474XX
</code></pre></div></td></tr></table></div>
Here we set the base software configuration for selecting SoC and other
board and SoC related settings.</p>
<h3 id="boardcmake"><a class="toclink" href="../../2024/08/16/a-new-board-is-born/#boardcmake">board.cmake</a></h3>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nb">board_runner_args</span><span class="p">(</span><span class="s">dfu-util</span><span class="w"> </span><span class="s2">&quot;--device=0483:df11&quot;</span><span class="w"> </span><span class="s2">&quot;--alt=0&quot;</span><span class="w"> </span><span class="s2">&quot;--dfuse&quot;</span><span class="p">)</span>

<span class="nb">include</span><span class="p">(</span><span class="o">${</span><span class="nv">ZEPHYR_BASE</span><span class="o">}</span><span class="s">/boards/common/dfu-util.board.cmake</span><span class="p">)</span>
<span class="nb">include</span><span class="p">(</span><span class="o">${</span><span class="nv">ZEPHYR_BASE</span><span class="o">}</span><span class="s">/boards/common/openocd.board.cmake</span><span class="p">)</span>
<span class="nb">include</span><span class="p">(</span><span class="o">${</span><span class="nv">ZEPHYR_BASE</span><span class="o">}</span><span class="s">/boards/common/blackmagicprobe.board.cmake</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
<p>Now we setup some things to make programming the board easier. You can
get the values for <code>--device</code> and <code>--alt</code> by running the <code>dfu-util -l</code>
when the board is plugged in and in DFU mode (for this one, that means
holding down the BOOT0 button while pressing the NRST button). You'll
get something like this:</p>
<div class="highlight"><pre><span></span><code>$ dfu-util -l
dfu-util 0.11

Copyright 2005-2009 Weston Schmidt, Harald Welte and OpenMoko Inc.
Copyright 2010-2021 Tormod Volden and Stefan Schmidt
This program is Free Software and has ABSOLUTELY NO WARRANTY
Please report bugs to http://sourceforge.net/p/dfu-util/tickets/

Found DFU: [0483:df11] ver=0200, devnum=1, cfg=1, intf=0, path=&quot;1-1&quot;, alt=2, name=&quot;@OTP Memory   /0x1FFF7000/01*1024 e&quot;, serial=&quot;205939885533&quot;
Found DFU: [0483:df11] ver=0200, devnum=1, cfg=1, intf=0, path=&quot;1-1&quot;, alt=1, name=&quot;@Option Bytes   /0x1FFF7800/01*048 e/0x1FFFF800/01*048 e&quot;, serial=&quot;205939885533&quot;
Found DFU: [0483:df11] ver=0200, devnum=1, cfg=1, intf=0, path=&quot;1-1&quot;, alt=0, name=&quot;@Internal Flash   /0x08000000/256*02Kg&quot;, serial=&quot;205939885533&quot;
</code></pre></div>
<p>Looking at this we can see the vendor and device ID in brackets
(<code>[0483:df11]</code>), and the <code>alt</code> targets.</p>
<h3 id="weact_stm32h474_longyaml"><a class="toclink" href="../../2024/08/16/a-new-board-is-born/#weact_stm32h474_longyaml">weact_stm32h474_long.yaml</a></h3>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nt">identifier</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">weact_stm32g474_long</span>
<span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">WeAct Studio STM32G474 Long Board</span>
<span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mcu</span>
<span class="nt">arch</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">arm</span>
<span class="nt">toolchain</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">zephyr</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">gnuarmemb</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">xtools</span>
<span class="nt">ram</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">128</span>
<span class="nt">flash</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">512</span>
<span class="nt">supported</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nvs</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pwm</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">i2c</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">gpio</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">usb device</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">counter</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">spi</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">watchdog</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">adc</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">dac</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">dma</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">can</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">rtc</span>
<span class="nt">vendor</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">weact</span>
</code></pre></div></td></tr></table></div>
<p>This metadata is used primarily by the <a href="https://docs.zephyrproject.org/latest/develop/test/twister.html#twister-script">test
runner</a>
to help determine which parts of the test suite to run. The reason is
you could target multiple boards with different capabilities, and then
adjust both your application and the testing to meet them.</p>
<h3 id="weact_stm32h474_long_defconfig"><a class="toclink" href="../../2024/08/16/a-new-board-is-born/#weact_stm32h474_long_defconfig">weact_stm32h474_long_defconfig</a></h3>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span></pre></div></td><td class="code"><div><pre><span></span><code>CONFIG_CLOCK_CONTROL<span class="s">=y</span>
CONFIG_PINCTRL<span class="s">=y</span>

CONFIG_ARM_MPU<span class="s">=y</span>
CONFIG_HW_STACK_PROTECTION<span class="s">=y</span>

CONFIG_GPIO<span class="s">=y</span>

CONFIG_SERIAL<span class="s">=y</span>
CONFIG_UART_INTERRUPT_DRIVEN<span class="s">=y</span>
CONFIG_CONSOLE<span class="s">=y</span>
CONFIG_UART_CONSOLE<span class="s">=y</span>
</code></pre></div></td></tr></table></div>
<p>Finally, we set some default Kconfig settings for every project that
they can override.  You can learn more about each of these, although I
think they're mostly self-evident, from this <a href="https://docs.zephyrproject.org/latest/kconfig.html">search
interface</a>. </p>
<h3 id="problems-i-ran-into-and-open-questions"><a class="toclink" href="../../2024/08/16/a-new-board-is-born/#problems-i-ran-into-and-open-questions">Problems I Ran Into and Open Questions</a></h3>
<p>I ran into a few problems along the way and have a few open questions.</p>
<ul>
<li>As <a href="../../2024/08/16/a-new-board-is-born/#clock-fun">mentioned earlier</a>, the clock tree was the hardest
  part that I ran into. This is also why I like an LED blink script to
  test the board with. It's the simplest thing to run, but it exposes
  timing issues quite quickly. You might not find a small error, but
  you'll definitely find <em>most</em> of them. </li>
<li>I still don't really understand a lot of the phandles for things like
  clocks. This is just a complex topic, and my search foo isn't finding
  the information I need to grok it. I'll get there eventually.</li>
<li>It's unclear to me how you would start with a clean slate. Definitely
  starting from a similar board helped enormously. </li>
<li>Eventually, I want to figure out how to add a new SOC. They're also
  defined through the device tree paradigm. </li>
</ul>
<p>I will be putting this up on Github at some point, but need to write
some documentation first, and make sure that I've shaken it out some,
before I subject the world to it. My intention is to submit it to the
Zephyr project for inclusion in future releases.</p>
<div class="admonition info">
<p class="admonition-title">Posted on Github</p>
<p>I have <a href="https://github.com/rebma-io/weact-stm32g474-core">posted this on
Github</a>, and it's
been renamed as the <code>core</code> board since it turns out both forms of
the board have the same pinouts just arranged slightly differently.</p>
<p>To do is cleaning it up and submitting it to the Zephyr project.</p>
</div>
<h3 id="blink-for-me-baby"><a class="toclink" href="../../2024/08/16/a-new-board-is-born/#blink-for-me-baby">Blink for Me Baby</a></h3>
<p>Here's the blink script that I used.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdlib.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;zephyr/drivers/gpio.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;zephyr/drivers/uart.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;zephyr/kernel.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;zephyr/sys/printk.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;zephyr/usb/usb_device.h&gt;</span>
</code></pre></div></td></tr></table></div>
<p>Just normal includes to get access to everything.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="cm">/* The devicetree node identifier for the &quot;led0&quot; alias. */</span>
<span class="cp">#define LED0_NODE DT_ALIAS(led0)</span>

<span class="cm">/*</span>
<span class="cm"> * A build error on this line means your board is unsupported.</span>
<span class="cm"> * See the sample documentation for information on how to fix this.</span>
<span class="cm"> */</span>
<span class="k">static</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">gpio_dt_spec</span><span class="w"> </span><span class="n">led</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GPIO_DT_SPEC_GET</span><span class="p">(</span><span class="n">LED0_NODE</span><span class="p">,</span><span class="w"> </span><span class="n">gpios</span><span class="p">);</span>
</code></pre></div></td></tr></table></div>
<p>Here's where all that device tree work comes into play. We first resolve
the <code>led0</code> alias, and then we get the GPIO spec for it. This abstraction
means that you can have a bunch of different boards with slightly
different wiring that don't require any software changes. For many uses,
it is unfortuantely, maybe an abstraction that obscures how things work.
I'm definitely of a mixed mood about it.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">sleep_ms</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">gpio_is_ready_dt</span><span class="p">(</span><span class="o">&amp;</span><span class="n">led</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gpio_pin_configure_dt</span><span class="p">(</span><span class="o">&amp;</span><span class="n">led</span><span class="p">,</span><span class="w"> </span><span class="n">GPIO_OUTPUT_ACTIVE</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ret</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>As befits an embedded system, there's no parameters passed to <code>main</code>. I
mean, where would they come from?</p>
<p>We then make sure that there's a GPIO pin attached to the <code>led</code>
variable, and then configure it to be an output pin.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">39</span>
<span class="normal">40</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="w">    </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">usb_enable</span><span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>
<span class="w">    </span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;usb_enable: %i&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">ret</span><span class="p">);</span>
</code></pre></div></td></tr></table></div>
<p>Here we enable the USB functionality. I ran into some issues here,
because according to the docs, this should return <code>0</code> on success, and
something negative on failure. But I got negative values no matter what,
and yet the USB was working. On the heap of things to dig into more. </p>
<p>I had originally wanted to loop here to wait until the console is
attached. For that, I just use
<a href="https://en.wikipedia.org/wiki/Minicom">minicom</a>, and it's executed on
my M1 Macbook Air as <code>minicom -D  /dev/tty.usbmodem1101 -b 115200</code>. Not
really sure that the baud rate matters, but I used it anyway.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gpio_pin_toggle_dt</span><span class="p">(</span><span class="o">&amp;</span><span class="n">led</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ret</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;LED state: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">gpio_pin_get</span><span class="p">(</span><span class="n">led</span><span class="p">.</span><span class="n">port</span><span class="p">,</span><span class="w"> </span><span class="n">led</span><span class="p">.</span><span class="n">pin</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="s">&quot;ON&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;OFF&quot;</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// 1000ms = 1s</span>
<span class="w">        </span><span class="n">k_msleep</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>Finally, we throw the program into an infinite loop and toggle the pin
off and on, printing out the current state of the pin and sleeping 1
second, leading to 1 second on and 1 second off. The program is
marginally more complicated than an Arduino sketch, but that's largely
because Arduino's framework hides many things from you. Up to a point,
this is a huge win, until it's not. For my overly complicated project, I
wanted to have it all exposed. I'll be diving into more advanced
features of Zephyr later like pub/sub, threading, sensor framework, etc.</p>
<p>And with that, we're kinda done? Somewhat done? The <a href="https://en.wikipedia.org/wiki/Magic_smoke">magic
smoke</a> didn't come out of the
chip, at least! </p>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
      <nav class="md-post__authors md-typeset">
        
          <span class="md-author">
            <img src="https://github.com/petrilli.png" alt="Christopher Petrilli">
          </span>
        
      </nav>
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2024-05-17 00:00:00">May 17, 2024</time></li>
        
          <li class="md-meta__item">
            in
            
              <a href="./" class="md-meta__link">Hardware</a></li>
        
        
          
          <li class="md-meta__item">
            
              2 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="oh-no-not-that-kind-of-oscillation"><a class="toclink" href="../../2024/05/17/oh-no-not-that-kind-of-oscillation/">Oh No, Not That Kind of Oscillation</a></h2>
<p>OK, so maybe things are not happy in switched mode land. In addition to
the issues identified in the <a href="../../2024/05/14/first-oscillation/">previous post</a>,
things are, to be fair, <em>not good</em>. The first issue is, I think, a minor
one. I accidentally misread the datasheet and the <code>P</code> part doesn't have
a soft-start pin, but a power good pin. This didn't turn out to be a
major issue, but more an annoyance.</p>
<p>The more substantial issue is this ...</p>
<p><img alt="A horrifying scope trace" src="../../img/tps566238-scope-oh-noes.png" /></p>
<p>That is, to use a technical term, not good. Not good at all.</p>
<p>Channel 1 (yellow) is the (attempted) 5V output. Channel 2 (cyan) is the
11V input. As you can see from the squiggly nature of the traces, things
are unwell in the land. Just a few of the horrors:</p>
<ol>
<li>The output is swinging <em>3 volts</em>, mostly around 5V, at least? This is
   not a good thing, and is what we might call "excessive ripple". Also,
   the ripple has ripple, which, if you're not Xzibit, is probably not a
   good thing.</li>
<li>The "ripple" is at 3.7kHz, which is a strange frequency that I can't
   seem to figure out the origin of.</li>
<li>The input is ... well, I wouldn't expect it to be swinging a full
   0.5V in either direction from the 11V setting that it was at.</li>
</ol>
<p>Further digging into it, just doesn't lead to any rational understanding
of the situation. All the capacitors measure reasonably with an LCR
meter (in circuit, so accuracy isn't great). Putting it under load, when
you get above 2A, the ripple shrinks suddenly to approximately 150mV,
which, while still high, is much more sane.</p>
<p>I'm honestly flummoxed.</p>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
      <nav class="md-post__authors md-typeset">
        
          <span class="md-author">
            <img src="https://github.com/petrilli.png" alt="Christopher Petrilli">
          </span>
        
      </nav>
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2024-05-14 00:00:00">May 14, 2024</time></li>
        
          <li class="md-meta__item">
            in
            
              <a href="./" class="md-meta__link">Hardware</a></li>
        
        
          
          <li class="md-meta__item">
            
              6 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="first-oscillation"><a class="toclink" href="../../2024/05/14/first-oscillation/">First Oscillation</a></h2>
<p>One of the things that this project is doing is pushing my skills
designing hardware. An area I had largely avoided until now was <a href="https://en.wikipedia.org/wiki/Switched-mode_power_supply">switch
mode power
supplies</a>
(SMPS). For this project, I am planning to use +12V as the base power
rail, +5V as the main distribution rail on the backplane for all the
cards, and then local regulation down to +3.3V. The +5V to +3.3V is
totally doable (and maybe even preferrably done) with a low dropout
(LDO) linear regulator. But the +12V to +5V is a bit more as we're
talking about 5-6A of current needed.</p>
<p>SMPS are typically <em>very efficient</em>, and I was hoping to use that to my
advantage. It's not that I really need the efficiency, but it's like
with machining, you always work to tight tolerances so when you need
them, you know how. TI has an <a href="https://webench.ti.com/power-designer/">amazing
tool</a> for building out power
circuits, and with some knob twiddling, it spit out a design based
around the <a href="https://www.ti.com/product/TPS566238">TPS566238</a>, a wee
little QFN package (3mm) that would have a target efficiency of 95%.
Perfect!</p>
<p>In this post, I'm hoping to dive into a bit of the design and some logic
around it all.</p>
<h3 id="the-centerpiece"><a class="toclink" href="../../2024/05/14/first-oscillation/#the-centerpiece">The Centerpiece</a></h3>
<p>Before digging into the specific implementation, let's talk about the
chip that it is built around. The
<a href="https://www.ti.com/product/TPS566238">TPS566238</a> is a <em>quite modern</em>
regulator for an SMPS. On the surface, the implementation is pretty
simple:</p>
<p><img alt="Typical application for TPS566238 with the IC, an inductor, and some
passives" src="../../img/tps566238-typical-application.png" /></p>
<p>That's it, right? Well, almost, but not quite as we'll see in a bit.</p>
<p>As I said earlier, part of the driver is the efficiency of the design,
which you can see here:</p>
<p><img alt="Efficiency v load chart for
TPS566238" src="../../img/tps566238-efficiency-graph.png" /></p>
<p>The part can support up to 6A of output current, which makes it perfect
for the use case. In addition, it has something like a 50&micro;A
quiescent current. Quiescent current being, very roughly, the "overhead"
of the chip, or the power that's used that isn't contributing to the
switching and outputs. It's more than that, but that's a close enough
definition for these purposes.</p>
<h3 id="the-beginning-and-the-end"><a class="toclink" href="../../2024/05/14/first-oscillation/#the-beginning-and-the-end">The Beginning and the End</a></h3>
<p><img align="right" alt="Schematic of a DIN connector with links to power
rails" src="../../img/schematic-tps566238-backplane.png" width="300" /></p>
<p>It all starts with power coming in at +12V, and going out at +5V. Since
the project is built around a DIN 41612-based backplane, we need to tie
all that together. As you can see from the schematic to the right, we
are using quite a few pins for power. The typical DIN 41612 connector is
rated at 2A <em>per contact</em>, so with 8 pins (4 at the "top", and 4 at the
"bottom"), that gives us a capacity of 16A, and while we'll need to
derate the capacity, we won't need to do so more than 15-20%, leaving us
plenty of excess current-carrying capacity.</p>
<p>Additionally, there are quite a few ground pins spread out through the
connector. I think it's <a href="https://www.protoexpress.com/blog/rick-hartley-pcb-design-recommendations-to-minimize-emi/">Rick
Hartley</a>
that recommends almost 50% grounds, I figured that since I was not doing
anything truly high-speed, that about 25% would be more than enough. </p>
<p>Now that we have both a source and sink for current, let's dig into the
meat of the design.</p>
<h3 id="theory-to-reality"><a class="toclink" href="../../2024/05/14/first-oscillation/#theory-to-reality">Theory to Reality</a></h3>
<p>The "typical application" shown in many data sheets is a highly
simplified version of the reality, but it's not misleadingly so. What I
ended up with, in the first round at least, was this:</p>
<p><img alt="Schematic of the main switch mode
circuit" src="../../img/schematic-tps566238-main.png" /></p>
<p>You'll see along the schematic, that there's a lot of text boxes with
various specs in them. These exist because, quite honestly, I wanted to
keep my thought process and decisions localized to the schematic for
future me to use. A few things to call out:</p>
<ol>
<li>I upped the inductor from 1.5 to 2.2uH, while keeping the DC
   resistance (DCR) and saturation current (IDC) roughly the same. The
   part I chose was <a href="https://productfinder.pulseelectronics.com/api/open/part-attachments/datasheet/BMQE000404111R0MAA">Pulse
   BMQ</a>
   part. This is a shielded inductor with an DCR of 8.5m&ohm; and an IDC
   of 12.5A. The additional inductance allows for a lower minimum input
   voltage.</li>
<li>I used a similar mix of capacitor packages as recommended, although
   slightly fewer 0402 packages. Smaller packages reduce the loop
   inductance of the circuit. I also tried to streamline the bill of
   materials (BOM) a bit by using multiple of certain capacitors rather
   than one large one. Everything on the board is either Murata or TDK
   X7R, with the exception of one X5R composition.</li>
<li>The feedback (FB) circuit is built with 1% Vishay
   <a href="https://www.vishay.com/en/product/20008/">CRCW</a> thick-film
   resistors. They're about $0.01, or less, in any quantity.</li>
<li>I didn't do anything with the enable (EN) pin. The datasheet is clear
   that if left unconnected, the internal pull-up resistor will activate
   the chip.</li>
</ol>
<p>That's it. Other than the tiny passives, it's not a super complicated
circuit.</p>
<h3 id="blinking-or-not-lights"><a class="toclink" href="../../2024/05/14/first-oscillation/#blinking-or-not-lights">Blinking (or not) Lights</a></h3>
<p>Everything needs more lights, although in this case, they shouldn't be
blinking.  The last little bit of the circuit was a test point and some
LEDs:</p>
<p><img alt="Schematic with LEDs" src="../../img/schematic-tps566238-leds.png" /></p>
<p>Again, as before, all the math and calculations around current-limiting
resistors is included in the schematic. The
<a href="https://optoelectronics.liteon.com/upload/download/DS22-2000-074/LTST-C190KGKT.PDF">LTST-C190KGKT</a>
are small 0603 LEDs. While I could have gone bigger, I'm trying to push
myself to work with smaller components, as that's just the direction the
industry is going in.</p>
<h3 id="the-result"><a class="toclink" href="../../2024/05/14/first-oscillation/#the-result">The Result</a></h3>
<p>I shipped the designs off to <a href="https://jlcpcb.com/">JLCPCB</a>, which is the
contract manufacturer I use almost exclusively, and after getting the
boards back, I did a janky job of soldering up everything, and
identified a few design issues:</p>
<ol>
<li>The QFN package is stupidly small. Like, just insane. But, I did
   manage to get it soldered the first time by applying a tiny bit of
   solder to the pads and then using a hot air reflow station.</li>
<li>The default footprint for the inductor is just barely too small, and
   required some finessing to get it to actually solder to the PCB.</li>
<li>I put an 0402 <em>right up against</em> the inductor, and that was just
   stupidly hard to solder. I went through 3-4 of them (cheap!) before I
   finally got something kinda not terrible.</li>
</ol>
<p><img align="right" alt="Multiple probes attached to a vertical
PCB" src="../../img/tps5662380-rev1A-measure.jpg" width="200" /></p>
<p>On first power up on a bench power supply with 12V and current heavily
limited, there was no smoke, which, given my inexperience here, and my
lousy soldering, is quite surprising. It even generated 5V. </p>
<p>It also generated not great output (about 500mV ripple) at around 3kHz
and a rather annoying 17kHz audible squeal which I could never quite
identify the source of. I think it was some kind of reverse microphonics
with the inductor because I could press on it and get the volume to
change. Fun! I think the output ripple <em>might</em> be related to not having
much load on it, as I couldn't find my programmable load in the
basement. SMPS don't really like being unloaded, and a 2W resistor
didn't help much there.</p>
<p>One final area I was worried about was whether or not temperature would
be an issue, so I let it run with what little load I could generate for
a while, and watched it on an IR camera.</p>
<p><img alt="Infrared snapshot of the board, 2 components identified at
34C" src="../../img/tps5662380-rev1A-temperature.jpg" /></p>
<p>As you can see, both the inductor and the regulator/controller both
stayed in a very safe range of 34.4-3.45&deg;C. I'll need to verify this
under load to have any confidence in the design, but that means finding
my programmable load.</p>
<p>Once I've got that, I need to run down those two issues. But, hey, for a
first SMPS ever, using tiny freaking parts, there was, in fact, no smoke
in the smoke test. So, for now, I'm happy.</p>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
      <nav class="md-post__authors md-typeset">
        
          <span class="md-author">
            <img src="https://github.com/petrilli.png" alt="Christopher Petrilli">
          </span>
        
      </nav>
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2024-05-04 00:00:00">May 4, 2024</time></li>
        
          <li class="md-meta__item">
            in
            
              <a href="./" class="md-meta__link">Hardware</a></li>
        
        
          
          <li class="md-meta__item">
            
              9 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="a-modular-base-board"><a class="toclink" href="../../2024/05/04/a-modular-base-board/">A Modular Base Board</a></h2>
<p>One of the things that really delighted me with the
<a href="https://github.com/kiu/kha">kha</a> project is the use of a common PCB for
the rack, and having it designed in such a way as to allow many
different applications. I decided I wanted to do the same thing, but
obviously with my own spin on it.</p>
<h3 id="goals"><a class="toclink" href="../../2024/05/04/a-modular-base-board/#goals">Goals</a></h3>
<p>The design has the following goals:</p>
<ol>
<li>A single re-usable PCB that can be used for 90% of the use cases.</li>
<li>Flexibility in programming and debugging</li>
<li>Local power regulation that leverages the +5V rail on the backplane.</li>
<li>Easy ability to change the run-time configuration.</li>
</ol>
<h3 id="subsystems"><a class="toclink" href="../../2024/05/04/a-modular-base-board/#subsystems">Subsystems</a></h3>
<p>I am using the term "subsystem" quite loosely here. Let's think of it
more as just different distinct parts of the base PCB that can be
populated as needed, and used as needed. Obviously some, like power,
will be there all the time, but others may only be present in a small
number of situations.</p>
<h4 id="power-regulation"><a class="toclink" href="../../2024/05/04/a-modular-base-board/#power-regulation">Power Regulation</a></h4>
<p>The main power rails of the backplane are +12V and +5V, as is tradition.
But that's not what "modern" microcontrollers run on. They run on, at
most, 3.3V (typically spelled "3v3"), and most can run on much lower
voltage. The STM32H5 series, for example, can run on anything from 1.71
to 3.6V. To simplify things (noise gets even more fun to deal with as
the potential drops), we'll run the board's main rail on 3.3V. </p>
<p>To get from 5V to 3.3V there are two options. First, we can use a linear
regulator in the form of a low-dropout (LDO) regulator. We could also
use a local switched mode power supply (SMPS). To choose, I think it's
worth thinking about two factor: what's the voltage drop, and what's the
power requirements.</p>
<p>Since we're going from 5 &rarr; 3.3V, that's only 1.7V, which isn't a
huge drop, and well within the capabilities of either type of power
supply. For power, let's look at what the <em>worst case</em> might be for that
3.3V rail:</p>
<table>
<thead>
<tr>
<th>Component</th>
<th style="text-align: right;">Qty</th>
<th style="text-align: right;">mA/ea</th>
<th style="text-align: right;">Total</th>
<th>Note</th>
</tr>
</thead>
<tbody>
<tr>
<td>STM32H503</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">200</td>
<td style="text-align: right;">200</td>
<td>&sum;IV<sub>VDD</sub></td>
</tr>
<tr>
<td>ATA6561</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0.35</td>
<td style="text-align: right;">0.35</td>
<td>CAN transceiver</td>
</tr>
<tr>
<td>LED</td>
<td style="text-align: right;">16</td>
<td style="text-align: right;">20</td>
<td style="text-align: right;">320</td>
<td>Typical I<sub>f</sub></td>
</tr>
<tr>
<td>ESP32-C3-MINI-1</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">350</td>
<td style="text-align: right;">350</td>
<td>TX 802.11b @ 20.5dBm</td>
</tr>
</tbody>
</table>
<p>That gets us a total of around 520.35mA for most situations, but 870.35
with an ESP32 with its WiFi radio lit up. Let's call that 900mA. Note,
this doesn't include the 5V drive for the CAN transceiver, for example,
which is typically 50mA when dominant, but is taken directly from the
backplane rail. Most other STM32 CPU are actually lower &sum;IV<sub>VDD</sub>
(the maximum current present across all V<sub>DD</sub> pins) by 50-80mA.</p>
<p><img align="right" alt="Schematic for a very simple LDO circuit with the
AP2114" src="../../img/schematic-ap2114-oem.png" width="240" /></p>
<p>Since there's not a massive amount of current, the plan is to use an
<a href="https://www.diodes.com/part/view/AP2114/">AP2114-3.3</a> fixed-output LDO
regulator. This is a super simple device that requires a very simple
circuit to implement, as shown to the right, which can deliver 1,000mA
(1A). The only addition is a tiny voltage divider to drive the EN
(enable) pin high from the +5V rail. The total cost for the circuit,
assuming 10 instances of it, is:</p>
<table>
<thead>
<tr>
<th>Component</th>
<th style="text-align: right;">Qty</th>
<th style="text-align: right;">Unit</th>
<th style="text-align: right;">Total</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="https://www.digikey.com/en/products/detail/diodes-incorporated/AP2114H-3-3TRG1/4470756">AP2114H-3.3</a></td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">$0.332</td>
<td style="text-align: right;">$0.332</td>
</tr>
<tr>
<td><a href="https://www.digikey.com/en/products/detail/murata-electronics/GRM21BR71C475KE51L/6606095">4.7uF MLCC 0805 capacitor</a></td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">$0.104</td>
<td style="text-align: right;">$0.208</td>
</tr>
<tr>
<td>0603 100mW &plusmn;1% SMD resistor</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">$0.01</td>
<td style="text-align: right;">$0.02</td>
</tr>
</tbody>
</table>
<p>That gets us to a whopping $0.56USD for the regulator circuit.</p>
<p>We do need to think about <a href="https://en.wikipedia.org/wiki/Junction_temperature">junction
temperature</a>, so
let's do a quick calculation of the "worst case" of a full 1A of power.</p>
<div class="arithmatex">\[\begin{align}
P &amp;= (V_{in} - V_{out}) \times I_{out} + (V_{in} \times I_{Q}) \\
  &amp;= (5 - 3.3)\times 1 + (5\times 0.065) \\
  &amp;= 1.7 + 0.325 \\ 
  &amp;= 2.025\textrm{W}
\end{align}
\]</div>
<p>So the most we might dissipate is 2W at <em>full load</em>. So, what does that
do to the junction temperature? Let's assume a 40C wost-case ambient
temperature (T<sub>A</sub>) and a
<a href="https://en.wikipedia.org/wiki/TO-252">TO-252-2</a> (that's what the H in
the part number refers to) package.</p>
<div class="arithmatex">\[\begin{align}
T_J &amp;= T_A + (\theta_{JA}\times P) \\
    &amp;= 40 + (35 * 2.025) \\
    &amp;= 110.875\textrm{C}
\end{align}
\]</div>
<p>The device has a thermal shutdown (T<sub>OTSD</sub>) of 160C, so we are safely
within the margins of the device. This is before we take into account
the use of the ground plane as a heat sink off the package tab.</p>
<h4 id="stdc-stm32-jtagswd-and-vcp"><a class="toclink" href="../../2024/05/04/a-modular-base-board/#stdc-stm32-jtagswd-and-vcp">STDC (STM32 JTAG/SWD and VCP)</a></h4>
<p><img align="right" alt="Samtec FTSH-107-01-L-DV-K-A connector" src="../../img/samtec-ftsh-14pos.jpg" width="150" /></p>
<p>Every board needs the ability to be programmed and debugged. The
standard in the STM32 ecosystem is the STDC connector, which provides
multiple functions simultaneously, and is typically exposed via a 0.500"
pitch 14-pin connector like the one shown here.</p>
<p>The pin-out according to
<a href="https://www.st.com/content/ccc/resource/technical/document/user_manual/group1/99/49/91/b6/b2/3a/46/e5/DM00526767/files/DM00526767.pdf/jcr:content/translations/en.DM00526767.pdf">UM2448</a>
is:</p>
<table>
<thead>
<tr>
<th>Pin</th>
<th>Function</th>
<th>Pin</th>
<th>Function</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>NC</td>
<td>2</td>
<td>NC</td>
</tr>
<tr>
<td>3</td>
<td>VCC</td>
<td>4</td>
<td>JTMS/SWDIO</td>
</tr>
<tr>
<td>5</td>
<td>GND</td>
<td>6</td>
<td>JCLK/SWCLK</td>
</tr>
<tr>
<td>7</td>
<td>GND</td>
<td>8</td>
<td>JTDO/SWO</td>
</tr>
<tr>
<td>9</td>
<td>JTCLK</td>
<td>10</td>
<td>JTDI</td>
</tr>
<tr>
<td>11</td>
<td>GND Detect</td>
<td>12</td>
<td>NRST</td>
</tr>
<tr>
<td>13</td>
<td>VCP_RX</td>
<td>14</td>
<td>VCP_TX</td>
</tr>
</tbody>
</table>
<p>The pins are for JTAG (J pins) or SWD (SW pins), along with the virtual
communications port (serial port) on the VCP pins.</p>
<p><img align="left" alt="Tag-Connect TC2070 connector and cable showing the spring-loaded pins
used" src="../../img/tag-connect-tc2070-idc-050.jpg" width="200" /></p>
<p>Unfortunately, those Samtec connectors <a href="https://www.digikey.com/en/products/detail/samtec-inc/FTSH-107-01-L-DV-K-A/7443623">aren't
cheap</a>,
running close to $4USD <em>each</em>. Instead, I'm planning to leverage the
<a href="https://www.tag-connect.com/">Tag-Connect</a> system, which uses a set of
spring-loaded pins to touch contacts on the board that don't require a
dedicated header to be installed. The
<a href="https://www.tag-connect.com/product/tc2070-idc-050">TC2060-IDC-050</a>
model fits the STDC use case perfectly.</p>
<p>For this situation, it's just a special footprint on the PCB. That
footprint looks something like this:</p>
<p><img alt="PCB footprint with 14 small circles and 3
holes" src="../../img/tag-connect-tc-2070-footprint.jpg" /></p>
<p>They're, effectively, free. And, if you use
<a href="https://en.wikipedia.org/wiki/Electroless_nickel_immersion_gold">ENIG</a>
finish, <em>very</em> durable.</p>
<h4 id="serial-console-maybe"><a class="toclink" href="../../2024/05/04/a-modular-base-board/#serial-console-maybe">Serial Console (maybe?)</a></h4>
<p>This is one I'm not completely sure of. There's a "serial port" on the
VCP part of the STDC header shown above, and this is probably all that's
needed. Still, I keep thinking maybe I should expose a dedicated serial
port for ... reasons that I cannot explain, other than "more ports
better".</p>
<h4 id="usb-connector-maybe"><a class="toclink" href="../../2024/05/04/a-modular-base-board/#usb-connector-maybe">USB Connector (maybe?)</a></h4>
<p>This is also a maybe for me. It's not really clear what the use for the
connector would be, and it's also unclear if it would make sense for it
to be either a host or peripheral connector as well. I can imagine there
being the possibility of an interesting use case of attaching devices to
the USB bus, however, so I'll likely include one. Whether it'll be a USB
micro or a USB-C is yet-to-be-determined.</p>
<h4 id="microsd-socket"><a class="toclink" href="../../2024/05/04/a-modular-base-board/#microsd-socket">MicroSD Socket</a></h4>
<p>One thing that I do want to include is a micro SD card connector. This
will allow for future expansion of both memory, but also potentially
allowing the SD card to contain the configuration for the board, which
might allow <em>every</em> board to be flashed with identical firmware.</p>
<p>This will likely be done with a <a href="https://www.cuidevices.com/product/interconnect/connectors/memory-card-connectors/sd-card-connectors/msd-1-a">CUI MSD-1-A
connector</a>.</p>
<h4 id="connector-tree"><a class="toclink" href="../../2024/05/04/a-modular-base-board/#connector-tree">Connector Tree</a></h4>
<p><img align="right" alt="JST PH 4-pin connector" src="../../img/jst-b4b-ph-k-s.jpg" width="150" /></p>
<p>This is the pice de rsistance that I am lifting from the original
design. The basic gist of it is that you pull GPIO/I2C/SPI signals out
to something like an 8-pin connector, then you fan it out to 2 smaller
connectors, and then potentially fan it out further to even smaller
connectors. This allows you to pick and choose what you need. You don't
even need to put all the connectors on the board unless you need them,
saving money further.</p>
<p>For a connector, I'm using the ubiquitous <a href="https://www.jst.com/products/crimp-style-connectors-wire-to-board-type/ph-connector/">JST
PH</a>
that you see everywhere. For example, in one variant, it's used for
Adafruit's <a href="https://learn.adafruit.com/introducing-adafruit-stemma-qt/what-is-stemma">STEMMA
connectors</a>.
It's widely used, distributed, and a very durable connector. </p>
<h4 id="power-connectors"><a class="toclink" href="../../2024/05/04/a-modular-base-board/#power-connectors">Power Connectors</a></h4>
<p>One of the things that I was thinking of doing is providing a bank of
power connectors. These could be used to provide 3.3V, 5V, or 12V to
front-panel devices directly from the board. They don't need to carry a
lot of current and I want to use a small connector, so I'm thinking of
using the same JST PH connectors as the signal tree, but in different
sizes so that hopefully I won't accidentally plug a signal into a 12V
power source. </p>
<p>This is an area that I just haven't fully thought through yet. For
example, the ubiquitous OLED screens need, typically a 5-12V input that
is then used locally to boost to the drive voltage. EPD (e-ink) screens
typically leverage 3.3V to feed the driver circuit. I'm not even sure
there's a real use-case for 12V here, which could simplify things. </p>
<h4 id="esp32-footprint"><a class="toclink" href="../../2024/05/04/a-modular-base-board/#esp32-footprint">ESP32 Footprint</a></h4>
<p><img align="left" alt="ESP32 module with castellated
pins" src="../../img/esp32-wroom-module.png" width="150" /></p>
<p>There are a few use cases where I can imagine wanting to have a WiFi
"modem" available. To do that, I'm intending to place the necessary pads
on the PCB for an
<a href="https://www.espressif.com/sites/default/files/documentation/esp32-c3-mini-1_datasheet_en.pdf">ESP32-C3-WROOM-1</a>
module. This is a <a href="https://riscv.org">RISC-V</a>-based module. The package
is only 16x13mm, and includes a PCB antenna. This will likely be against
the upper edge of the card so that the copper exclusion zone necessary
for the antenna doesn't interfere with the main function of the board. </p>
<p>This will be hung off one of the UART channels of the STM32
microcontroller, and programmed with the <a href="https://github.com/espressif/esp-at">ESP32 AT
firmware</a>, which presents a full
TCP/IP stack, with TLS, HTTP, and even MQTT support, over a crazy
modified <a href="https://en.wikipedia.org/wiki/Hayes_AT_command_set">Hayes</a> <a href="https://docs.espressif.com/projects/esp-at/en/latest/esp32/AT_Command_Set/index.html">AT
command
set</a>.
I believe it maxes out (or maybe just defaults to) 115,200bps, which
should be fine for most any real application like checking network time
or web APIs. If that ends up being not enough, there is an SPI interface
option that can run 10x faster. </p>
<h4 id="status-leds"><a class="toclink" href="../../2024/05/04/a-modular-base-board/#status-leds">Status LEDs</a></h4>
<p>Every computer needs blinking lights. This much is indisputable. So
every board will have a few selection of lights for power rail status,
MCU status, and maybe CAN bus status. These will likely just be 0603 or
0805 surface mount LEDs on the PCB itself. There may, however, be a
front-panel LED that is just a "power good" LED. That would be connected
to a dedicated connector on the PCB.</p>
<h4 id="reset-switch"><a class="toclink" href="../../2024/05/04/a-modular-base-board/#reset-switch">Reset Switch</a></h4>
<p><img align="right" alt="Panasonic EVQ-P7A01P tactile SMD
switch" src="../../img/panasonic-evq-p7a01p.jpg" width="150" /></p>
<p>Finally, every computer needs a physical reset switch. In this case,
tied to the NRST pin on the controller. When this gets pulled low, the
processor goes into system reset. The plan is to use these small
surface-mount tactile switches at the <em>very front</em> of the PCB that will
be able to be pressed via a small rod (paperclip, naturally) through a
small hole in the front panel.</p>
<h3 id="next-steps"><a class="toclink" href="../../2024/05/04/a-modular-base-board/#next-steps">Next Steps</a></h3>
<p>I have a first prototype of the connector tree part of the board I've
done, but I'm not happy with it. I'm planning to go back to the drawing
board once I pick a specific MCU so that I can optimize the design to
maximize the flexibility of alternate functions on various pins. In
addition, the initial design didn't have any power on the connectors, so
you had to depend on the MCU to source power, which isn't a great way to
drive a lot of things.</p>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
      <nav class="md-post__authors md-typeset">
        
          <span class="md-author">
            <img src="https://github.com/petrilli.png" alt="Christopher Petrilli">
          </span>
        
      </nav>
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2024-05-03 00:00:00">May 3, 2024</time></li>
        
          <li class="md-meta__item">
            in
            
              <a href="./" class="md-meta__link">Hardware</a></li>
        
        
          
          <li class="md-meta__item">
            
              4 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="can-on-8p8c-connectors"><a class="toclink" href="../../2024/05/03/can-on-8p8c-connectors/">CAN on 8p8c Connectors</a></h2>
<div class="admonition info inline end">
<p class="admonition-title">8p8c is not RJ45</p>
<p><em>Pedantic Warning</em> You will often hear people call the modular
  connectors that are used for Ethernet "RJ45", but that standard is
  a very specific thing that is not actually what you're using. The
  correct term is an 8p8c connector, which refers to the 8 positions
  and 8 contacts. </p>
<p>I have often done this myself, but for the purposes of being 
  <a href="https://www.youtube.com/watch?v=hou0lU8WMgo">technically correct</a>, 
  I will try my best to stick to the proper designation.</p>
</div>
<p>For the project, I want to connect the string of devices over CANbus. To
do that, I intend to leverage the ubiquitous
<a href="https://en.wikipedia.org/wiki/Modular_connector#8P8C">8p8c</a> that you
see all over the place in Ethernet.</p>
<h3 id="goals"><a class="toclink" href="../../2024/05/03/can-on-8p8c-connectors/#goals">Goals</a></h3>
<p>There were a few goals in mind:</p>
<ol>
<li>Use existing standards and easily available connectors and cables</li>
<li>Deliver power over the same cable as the signal</li>
<li>Provide reasonable noise immunity</li>
</ol>
<p>The noise immunity is pretty easy given this is a differential signal
and we are going to use twisted pairs to twist the high and low signal
together. Looking at an oscilloscope trace of the CAN signal from <a href="https://www.ti.com/lit/an/sloa101b/sloa101b.pdf">this
TI application note</a>,
you can see the differential nature:</p>
<p><img alt="An oscilloscope plot showing a single-ended signal converted to
differential signal" src="../../img/ti-sloa101b-can-bus.png" /></p>
<h3 id="connector-signal-mapping"><a class="toclink" href="../../2024/05/03/can-on-8p8c-connectors/#connector-signal-mapping">Connector Signal Mapping</a></h3>
<p>For the ends, I chose to use a rather boring layout, but I wanted to
make sure CAN was twisted together, and that each of the +12V wires was
also twisted with a ground.</p>
<p><svg width="119pt" height="238pt" viewBox="0.00 0.00 119.00 238.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 234)"><title>%3</title><polygon fill="#ffffff" stroke="transparent" points="-4,4 -4,-234 115,-234 115,4 -4,4"/><!-- X1 --><g id="node1" class="node"><title>X1</title><polygon fill="#ffffff" stroke="black" points="111,-230 0,-230 0,0 111,0 111,-230"/><polygon fill="none" stroke="black" points="0.5,-207 0.5,-230 111.5,-230 111.5,-207 0.5,-207"/><text text-anchor="start" x="47.5" y="-214.8" font-family="arial" font-size="14.00">X1</text><polygon fill="none" stroke="black" points="0.5,-184 0.5,-207 38.5,-207 38.5,-184 0.5,-184"/><text text-anchor="start" x="4.5" y="-191.8" font-family="arial" font-size="14.00">8p8c</text><polygon fill="none" stroke="black" points="38.5,-184 38.5,-207 72.5,-207 72.5,-184 38.5,-184"/><text text-anchor="start" x="42.5" y="-191.8" font-family="arial" font-size="14.00">plug</text><polygon fill="none" stroke="black" points="72.5,-184 72.5,-207 111.5,-207 111.5,-184 72.5,-184"/><text text-anchor="start" x="76.5" y="-191.8" font-family="arial" font-size="14.00">8&#45;pin</text><polygon fill="none" stroke="black" points="0.5,-161 0.5,-184 37.5,-184 37.5,-161 0.5,-161"/><text text-anchor="start" x="15" y="-168.8" font-family="arial" font-size="14.00">1</text><polygon fill="none" stroke="black" points="37.5,-161 37.5,-184 111.5,-184 111.5,-161 37.5,-161"/><text text-anchor="start" x="51.5" y="-168.8" font-family="arial" font-size="14.00">CAN_H</text><polygon fill="none" stroke="black" points="0.5,-138 0.5,-161 37.5,-161 37.5,-138 0.5,-138"/><text text-anchor="start" x="15" y="-145.8" font-family="arial" font-size="14.00">2</text><polygon fill="none" stroke="black" points="37.5,-138 37.5,-161 111.5,-161 111.5,-138 37.5,-138"/><text text-anchor="start" x="52.5" y="-145.8" font-family="arial" font-size="14.00">CAN_L</text><polygon fill="none" stroke="black" points="0.5,-115 0.5,-138 37.5,-138 37.5,-115 0.5,-115"/><text text-anchor="start" x="15" y="-122.8" font-family="arial" font-size="14.00">3</text><polygon fill="none" stroke="black" points="37.5,-115 37.5,-138 111.5,-138 111.5,-115 37.5,-115"/><text text-anchor="start" x="59" y="-122.8" font-family="arial" font-size="14.00">GND</text><polygon fill="none" stroke="black" points="0.5,-92 0.5,-115 37.5,-115 37.5,-92 0.5,-92"/><text text-anchor="start" x="15" y="-99.8" font-family="arial" font-size="14.00">4</text><polygon fill="none" stroke="black" points="37.5,-92 37.5,-115 111.5,-115 111.5,-92 37.5,-92"/><text text-anchor="start" x="58" y="-99.8" font-family="arial" font-size="14.00">+12V</text><polygon fill="none" stroke="black" points="0.5,-69 0.5,-92 37.5,-92 37.5,-69 0.5,-69"/><text text-anchor="start" x="15" y="-76.8" font-family="arial" font-size="14.00">5</text><polygon fill="none" stroke="black" points="37.5,-69 37.5,-92 111.5,-92 111.5,-69 37.5,-69"/><text text-anchor="start" x="58" y="-76.8" font-family="arial" font-size="14.00">+12V</text><polygon fill="none" stroke="black" points="0.5,-46 0.5,-69 37.5,-69 37.5,-46 0.5,-46"/><text text-anchor="start" x="15" y="-53.8" font-family="arial" font-size="14.00">6</text><polygon fill="none" stroke="black" points="37.5,-46 37.5,-69 111.5,-69 111.5,-46 37.5,-46"/><text text-anchor="start" x="59" y="-53.8" font-family="arial" font-size="14.00">GND</text><polygon fill="none" stroke="black" points="0.5,-23 0.5,-46 37.5,-46 37.5,-23 0.5,-23"/><text text-anchor="start" x="15" y="-30.8" font-family="arial" font-size="14.00">7</text><polygon fill="none" stroke="black" points="37.5,-23 37.5,-46 111.5,-46 111.5,-23 37.5,-23"/><text text-anchor="start" x="59" y="-30.8" font-family="arial" font-size="14.00">GND</text><polygon fill="none" stroke="black" points="0.5,0 0.5,-23 37.5,-23 37.5,0 0.5,0"/><text text-anchor="start" x="15" y="-7.8" font-family="arial" font-size="14.00">8</text><polygon fill="none" stroke="black" points="37.5,0 37.5,-23 111.5,-23 111.5,0 37.5,0"/><text text-anchor="start" x="58" y="-7.8" font-family="arial" font-size="14.00">+12V</text></g></g></svg></p>
<h3 id="cable-wiring"><a class="toclink" href="../../2024/05/03/can-on-8p8c-connectors/#cable-wiring">Cable Wiring</a></h3>
<p>The wiring is standard Ethernet wiring, following the
<a href="https://www.flukenetworks.com/knowledge-base/application-or-standards-articles-copper/differences-between-wiring-codes-t568a-vs">T568A</a>
standard. The reality is that it doesn't matter whether you use T568A or
T568B, quite honestly, but I just picked A because it's the most common
and what the typical patch cable is wired for.</p>
<p><a href="https://en.wikipedia.org/wiki/Category_5_cable">Category 5/5e</a> is more
than adequate for the signalling that CAN or CAN FD use. The general
rating for Category 5 is 100MHz, and if we look at a quality cable, like
the <a href="https://www.belden.com/products/cable/ethernet-cable/category-5e-cable/1224">Belden
1224</a>,
we can see that it has the following characteristics:</p>
<table>
<thead>
<tr>
<th>Max DCR</th>
<th>Max DCR Imbalance</th>
<th>Max Capacitance</th>
<th>Insertion Loss(100MHz)</th>
<th>Fitted Impedence</th>
</tr>
</thead>
<tbody>
<tr>
<td>89&ohm;/km</td>
<td>3%</td>
<td>33pF/100m</td>
<td>21dB/100m</td>
<td>100&plusmn;15&ohm;</td>
</tr>
</tbody>
</table>
<p>And it is, in fact, rated to 350MHz, far in excess of what's needed.</p>
<p>The makes the overall wiring looks like this:</p>
<p><svg width="777pt" height="324pt" viewBox="0.00 0.00 777.00 324.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 320)"><title>%3</title><polygon fill="#ffffff" stroke="transparent" points="-4,4 -4,-320 773,-320 773,4 -4,4"/><!-- X1 --><g id="node1" class="node"><title>X1</title><polygon fill="#ffffff" stroke="black" points="111,-264 0,-264 0,-34 111,-34 111,-264"/><polygon fill="none" stroke="black" points="0.5,-241 0.5,-264 111.5,-264 111.5,-241 0.5,-241"/><text text-anchor="start" x="47.5" y="-248.8" font-family="arial" font-size="14.00">X1</text><polygon fill="none" stroke="black" points="0.5,-218 0.5,-241 38.5,-241 38.5,-218 0.5,-218"/><text text-anchor="start" x="4.5" y="-225.8" font-family="arial" font-size="14.00">8p8c</text><polygon fill="none" stroke="black" points="38.5,-218 38.5,-241 72.5,-241 72.5,-218 38.5,-218"/><text text-anchor="start" x="42.5" y="-225.8" font-family="arial" font-size="14.00">plug</text><polygon fill="none" stroke="black" points="72.5,-218 72.5,-241 111.5,-241 111.5,-218 72.5,-218"/><text text-anchor="start" x="76.5" y="-225.8" font-family="arial" font-size="14.00">8&#45;pin</text><polygon fill="none" stroke="black" points="0.5,-195 0.5,-218 75.5,-218 75.5,-195 0.5,-195"/><text text-anchor="start" x="15" y="-202.8" font-family="arial" font-size="14.00">CAN_H</text><polygon fill="none" stroke="black" points="75.5,-195 75.5,-218 111.5,-218 111.5,-195 75.5,-195"/><text text-anchor="start" x="89.5" y="-202.8" font-family="arial" font-size="14.00">1</text><polygon fill="none" stroke="black" points="0.5,-172 0.5,-195 75.5,-195 75.5,-172 0.5,-172"/><text text-anchor="start" x="16" y="-179.8" font-family="arial" font-size="14.00">CAN_L</text><polygon fill="none" stroke="black" points="75.5,-172 75.5,-195 111.5,-195 111.5,-172 75.5,-172"/><text text-anchor="start" x="89.5" y="-179.8" font-family="arial" font-size="14.00">2</text><polygon fill="none" stroke="black" points="0.5,-149 0.5,-172 75.5,-172 75.5,-149 0.5,-149"/><text text-anchor="start" x="22.5" y="-156.8" font-family="arial" font-size="14.00">GND</text><polygon fill="none" stroke="black" points="75.5,-149 75.5,-172 111.5,-172 111.5,-149 75.5,-149"/><text text-anchor="start" x="89.5" y="-156.8" font-family="arial" font-size="14.00">3</text><polygon fill="none" stroke="black" points="0.5,-126 0.5,-149 75.5,-149 75.5,-126 0.5,-126"/><text text-anchor="start" x="21.5" y="-133.8" font-family="arial" font-size="14.00">+12V</text><polygon fill="none" stroke="black" points="75.5,-126 75.5,-149 111.5,-149 111.5,-126 75.5,-126"/><text text-anchor="start" x="89.5" y="-133.8" font-family="arial" font-size="14.00">4</text><polygon fill="none" stroke="black" points="0.5,-103 0.5,-126 75.5,-126 75.5,-103 0.5,-103"/><text text-anchor="start" x="21.5" y="-110.8" font-family="arial" font-size="14.00">+12V</text><polygon fill="none" stroke="black" points="75.5,-103 75.5,-126 111.5,-126 111.5,-103 75.5,-103"/><text text-anchor="start" x="89.5" y="-110.8" font-family="arial" font-size="14.00">5</text><polygon fill="none" stroke="black" points="0.5,-80 0.5,-103 75.5,-103 75.5,-80 0.5,-80"/><text text-anchor="start" x="22.5" y="-87.8" font-family="arial" font-size="14.00">GND</text><polygon fill="none" stroke="black" points="75.5,-80 75.5,-103 111.5,-103 111.5,-80 75.5,-80"/><text text-anchor="start" x="89.5" y="-87.8" font-family="arial" font-size="14.00">6</text><polygon fill="none" stroke="black" points="0.5,-57 0.5,-80 75.5,-80 75.5,-57 0.5,-57"/><text text-anchor="start" x="22.5" y="-64.8" font-family="arial" font-size="14.00">GND</text><polygon fill="none" stroke="black" points="75.5,-57 75.5,-80 111.5,-80 111.5,-57 75.5,-57"/><text text-anchor="start" x="89.5" y="-64.8" font-family="arial" font-size="14.00">7</text><polygon fill="none" stroke="black" points="0.5,-34 0.5,-57 75.5,-57 75.5,-34 0.5,-34"/><text text-anchor="start" x="21.5" y="-41.8" font-family="arial" font-size="14.00">+12V</text><polygon fill="none" stroke="black" points="75.5,-34 75.5,-57 111.5,-57 111.5,-34 75.5,-34"/><text text-anchor="start" x="89.5" y="-41.8" font-family="arial" font-size="14.00">8</text></g><!-- W1 --><g id="node3" class="node"><title>W1</title><polygon fill="#ffffff" stroke="black" points="514,-316 255,-316 255,0 514,0 514,-316"/><polygon fill="none" stroke="black" points="255.5,-293 255.5,-316 514.5,-316 514.5,-293 255.5,-293"/><text text-anchor="start" x="374" y="-300.8" font-family="arial" font-size="14.00">W1</text><polygon fill="none" stroke="black" points="255.5,-270 255.5,-293 318.5,-293 318.5,-270 255.5,-270"/><text text-anchor="start" x="270" y="-277.8" font-family="arial" font-size="14.00">cat5e</text><polygon fill="none" stroke="black" points="318.5,-270 318.5,-293 362.5,-293 362.5,-270 318.5,-270"/><text text-anchor="start" x="333" y="-277.8" font-family="arial" font-size="14.00">8x</text><polygon fill="none" stroke="black" points="362.5,-270 362.5,-293 514.5,-293 514.5,-270 362.5,-270"/><text text-anchor="start" x="376.5" y="-277.8" font-family="arial" font-size="14.00">24 AWG (0.25 mm)</text><text text-anchor="start" x="294.5" y="-256.8" font-family="arial" font-size="14.00"></text><text text-anchor="start" x="257.5" y="-237.8" font-family="arial" font-size="14.00">X1:1:CAN_H</text><text text-anchor="start" x="340" y="-237.8" font-family="arial" font-size="14.00"> &#160;&#160;&#160;&#160;1:WHGN &#160;&#160;&#160;</text><text text-anchor="start" x="434.5" y="-237.8" font-family="arial" font-size="14.00">X2:1:CAN_H</text><polygon fill="#000000" stroke="transparent" points="255.5,-230 255.5,-232 514.5,-232 514.5,-230 255.5,-230"/><polygon fill="#ffffff" stroke="transparent" points="255.5,-228 255.5,-230 514.5,-230 514.5,-228 255.5,-228"/><polygon fill="#00ff00" stroke="transparent" points="255.5,-226 255.5,-228 514.5,-228 514.5,-226 255.5,-226"/><polygon fill="#ffffff" stroke="transparent" points="255.5,-224 255.5,-226 514.5,-226 514.5,-224 255.5,-224"/><polygon fill="#000000" stroke="transparent" points="255.5,-222 255.5,-224 514.5,-224 514.5,-222 255.5,-222"/><text text-anchor="start" x="258.5" y="-208.8" font-family="arial" font-size="14.00">X1:2:CAN_L</text><text text-anchor="start" x="351.5" y="-208.8" font-family="arial" font-size="14.00"> &#160;&#160;&#160;&#160;2:GN &#160;&#160;&#160;</text><text text-anchor="start" x="435.5" y="-208.8" font-family="arial" font-size="14.00">X2:2:CAN_L</text><polygon fill="#000000" stroke="transparent" points="255.5,-201 255.5,-203 514.5,-203 514.5,-201 255.5,-201"/><polygon fill="#00ff00" stroke="transparent" points="255.5,-199 255.5,-201 514.5,-201 514.5,-199 255.5,-199"/><polygon fill="#00ff00" stroke="transparent" points="255.5,-197 255.5,-199 514.5,-199 514.5,-197 255.5,-197"/><polygon fill="#00ff00" stroke="transparent" points="255.5,-195 255.5,-197 514.5,-197 514.5,-195 255.5,-195"/><polygon fill="#000000" stroke="transparent" points="255.5,-193 255.5,-195 514.5,-195 514.5,-193 255.5,-193"/><text text-anchor="start" x="265" y="-179.8" font-family="arial" font-size="14.00">X1:3:GND</text><text text-anchor="start" x="339.5" y="-179.8" font-family="arial" font-size="14.00"> &#160;&#160;&#160;&#160;3:WHOG &#160;&#160;&#160;</text><text text-anchor="start" x="442" y="-179.8" font-family="arial" font-size="14.00">X2:3:GND</text><polygon fill="#000000" stroke="transparent" points="255.5,-172 255.5,-174 514.5,-174 514.5,-172 255.5,-172"/><polygon fill="#ffffff" stroke="transparent" points="255.5,-170 255.5,-172 514.5,-172 514.5,-170 255.5,-170"/><polygon fill="#ff8000" stroke="transparent" points="255.5,-168 255.5,-170 514.5,-170 514.5,-168 255.5,-168"/><polygon fill="#ffffff" stroke="transparent" points="255.5,-166 255.5,-168 514.5,-168 514.5,-166 255.5,-166"/><polygon fill="#000000" stroke="transparent" points="255.5,-164 255.5,-166 514.5,-166 514.5,-164 255.5,-164"/><text text-anchor="start" x="264.5" y="-150.8" font-family="arial" font-size="14.00">X1:4:+12V</text><text text-anchor="start" x="353" y="-150.8" font-family="arial" font-size="14.00"> &#160;&#160;&#160;&#160;4:BU &#160;&#160;&#160;</text><text text-anchor="start" x="441.5" y="-150.8" font-family="arial" font-size="14.00">X2:4:+12V</text><polygon fill="#000000" stroke="transparent" points="255.5,-143 255.5,-145 514.5,-145 514.5,-143 255.5,-143"/><polygon fill="#0066ff" stroke="transparent" points="255.5,-141 255.5,-143 514.5,-143 514.5,-141 255.5,-141"/><polygon fill="#0066ff" stroke="transparent" points="255.5,-139 255.5,-141 514.5,-141 514.5,-139 255.5,-139"/><polygon fill="#0066ff" stroke="transparent" points="255.5,-137 255.5,-139 514.5,-139 514.5,-137 255.5,-137"/><polygon fill="#000000" stroke="transparent" points="255.5,-135 255.5,-137 514.5,-137 514.5,-135 255.5,-135"/><text text-anchor="start" x="264.5" y="-121.8" font-family="arial" font-size="14.00">X1:5:+12V</text><text text-anchor="start" x="341" y="-121.8" font-family="arial" font-size="14.00"> &#160;&#160;&#160;&#160;5:WHBU &#160;&#160;&#160;</text><text text-anchor="start" x="441.5" y="-121.8" font-family="arial" font-size="14.00">X2:5:+12V</text><polygon fill="#000000" stroke="transparent" points="255.5,-114 255.5,-116 514.5,-116 514.5,-114 255.5,-114"/><polygon fill="#ffffff" stroke="transparent" points="255.5,-112 255.5,-114 514.5,-114 514.5,-112 255.5,-112"/><polygon fill="#0066ff" stroke="transparent" points="255.5,-110 255.5,-112 514.5,-112 514.5,-110 255.5,-110"/><polygon fill="#ffffff" stroke="transparent" points="255.5,-108 255.5,-110 514.5,-110 514.5,-108 255.5,-108"/><polygon fill="#000000" stroke="transparent" points="255.5,-106 255.5,-108 514.5,-108 514.5,-106 255.5,-106"/><text text-anchor="start" x="265" y="-92.8" font-family="arial" font-size="14.00">X1:6:GND</text><text text-anchor="start" x="351" y="-92.8" font-family="arial" font-size="14.00"> &#160;&#160;&#160;&#160;6:OG &#160;&#160;&#160;</text><text text-anchor="start" x="442" y="-92.8" font-family="arial" font-size="14.00">X2:6:GND</text><polygon fill="#000000" stroke="transparent" points="255.5,-85 255.5,-87 514.5,-87 514.5,-85 255.5,-85"/><polygon fill="#ff8000" stroke="transparent" points="255.5,-83 255.5,-85 514.5,-85 514.5,-83 255.5,-83"/><polygon fill="#ff8000" stroke="transparent" points="255.5,-81 255.5,-83 514.5,-83 514.5,-81 255.5,-81"/><polygon fill="#ff8000" stroke="transparent" points="255.5,-79 255.5,-81 514.5,-81 514.5,-79 255.5,-79"/><polygon fill="#000000" stroke="transparent" points="255.5,-77 255.5,-79 514.5,-79 514.5,-77 255.5,-77"/><text text-anchor="start" x="265" y="-63.8" font-family="arial" font-size="14.00">X1:7:GND</text><text text-anchor="start" x="341" y="-63.8" font-family="arial" font-size="14.00"> &#160;&#160;&#160;&#160;7:WHBN &#160;&#160;&#160;</text><text text-anchor="start" x="442" y="-63.8" font-family="arial" font-size="14.00">X2:7:GND</text><polygon fill="#000000" stroke="transparent" points="255.5,-56 255.5,-58 514.5,-58 514.5,-56 255.5,-56"/><polygon fill="#ffffff" stroke="transparent" points="255.5,-54 255.5,-56 514.5,-56 514.5,-54 255.5,-54"/><polygon fill="#895956" stroke="transparent" points="255.5,-52 255.5,-54 514.5,-54 514.5,-52 255.5,-52"/><polygon fill="#ffffff" stroke="transparent" points="255.5,-50 255.5,-52 514.5,-52 514.5,-50 255.5,-50"/><polygon fill="#000000" stroke="transparent" points="255.5,-48 255.5,-50 514.5,-50 514.5,-48 255.5,-48"/><text text-anchor="start" x="264.5" y="-34.8" font-family="arial" font-size="14.00">X1:8:+12V</text><text text-anchor="start" x="353" y="-34.8" font-family="arial" font-size="14.00"> &#160;&#160;&#160;&#160;8:BN &#160;&#160;&#160;</text><text text-anchor="start" x="441.5" y="-34.8" font-family="arial" font-size="14.00">X2:8:+12V</text><polygon fill="#000000" stroke="transparent" points="255.5,-27 255.5,-29 514.5,-29 514.5,-27 255.5,-27"/><polygon fill="#895956" stroke="transparent" points="255.5,-25 255.5,-27 514.5,-27 514.5,-25 255.5,-25"/><polygon fill="#895956" stroke="transparent" points="255.5,-23 255.5,-25 514.5,-25 514.5,-23 255.5,-23"/><polygon fill="#895956" stroke="transparent" points="255.5,-21 255.5,-23 514.5,-23 514.5,-21 255.5,-21"/><polygon fill="#000000" stroke="transparent" points="255.5,-19 255.5,-21 514.5,-21 514.5,-19 255.5,-19"/><text text-anchor="start" x="294.5" y="-5.8" font-family="arial" font-size="14.00"></text></g><!-- X1&#45;&#45;W1 --><g id="edge1" class="edge"><title>X1:e&#45;&#45;W1:w</title><path fill="none" stroke="#000000" stroke-width="2" d="M111,-203C178.83,-204.62 193.6,-224.62 255,-223"/><path fill="none" stroke="#ffffff" stroke-width="2" d="M111,-205C177.22,-205.81 191.99,-225.81 255,-225"/><path fill="none" stroke="#00ff00" stroke-width="2" d="M111,-207C175.61,-207 190.39,-227 255,-227"/><path fill="none" stroke="#ffffff" stroke-width="2" d="M111,-209C174.01,-208.19 188.78,-228.19 255,-229"/><path fill="none" stroke="#000000" stroke-width="2" d="M111,-211C172.4,-209.38 187.17,-229.38 255,-231"/></g><!-- X1&#45;&#45;W1 --><g id="edge3" class="edge"><title>X1:e&#45;&#45;W1:w</title><path fill="none" stroke="#000000" stroke-width="2" d="M111,-180C177.99,-181.04 193.39,-195.04 255,-194"/><path fill="none" stroke="#00ff00" stroke-width="2" d="M111,-182C176.65,-182.52 192.04,-196.52 255,-196"/><path fill="none" stroke="#00ff00" stroke-width="2" d="M111,-184C175.3,-184 190.7,-198 255,-198"/><path fill="none" stroke="#00ff00" stroke-width="2" d="M111,-186C173.96,-185.48 189.35,-199.48 255,-200"/><path fill="none" stroke="#000000" stroke-width="2" d="M111,-188C172.61,-186.96 188.01,-200.96 255,-202"/></g><!-- X1&#45;&#45;W1 --><g id="edge5" class="edge"><title>X1:e&#45;&#45;W1:w</title><path fill="none" stroke="#000000" stroke-width="2" d="M111,-157C176.91,-157.43 192.71,-165.43 255,-165"/><path fill="none" stroke="#ffffff" stroke-width="2" d="M111,-159C176,-159.22 191.8,-167.22 255,-167"/><path fill="none" stroke="#ff8000" stroke-width="2" d="M111,-161C175.1,-161 190.9,-169 255,-169"/><path fill="none" stroke="#ffffff" stroke-width="2" d="M111,-163C174.2,-162.78 190,-170.78 255,-171"/><path fill="none" stroke="#000000" stroke-width="2" d="M111,-165C173.29,-164.57 189.09,-172.57 255,-173"/></g><!-- X1&#45;&#45;W1 --><g id="edge7" class="edge"><title>X1:e&#45;&#45;W1:w</title><path fill="none" stroke="#000000" stroke-width="2" d="M111,-133C175.75,-133.07 191.72,-136.07 255,-136"/><path fill="none" stroke="#0066ff" stroke-width="2" d="M111,-135C175.38,-135.03 191.36,-138.03 255,-138"/><path fill="none" stroke="#0066ff" stroke-width="2" d="M111,-137C175.01,-137 190.99,-140 255,-140"/><path fill="none" stroke="#0066ff" stroke-width="2" d="M111,-139C174.64,-138.97 190.62,-141.97 255,-142"/><path fill="none" stroke="#000000" stroke-width="2" d="M111,-141C174.28,-140.93 190.25,-143.93 255,-144"/></g><!-- X1&#45;&#45;W1 --><g id="edge9" class="edge"><title>X1:e&#45;&#45;W1:w</title><path fill="none" stroke="#000000" stroke-width="2" d="M111,-110C174.28,-110.07 190.25,-107.07 255,-107"/><path fill="none" stroke="#ffffff" stroke-width="2" d="M111,-112C174.64,-112.03 190.62,-109.03 255,-109"/><path fill="none" stroke="#0066ff" stroke-width="2" d="M111,-114C175.01,-114 190.99,-111 255,-111"/><path fill="none" stroke="#ffffff" stroke-width="2" d="M111,-116C175.38,-115.97 191.36,-112.97 255,-113"/><path fill="none" stroke="#000000" stroke-width="2" d="M111,-118C175.75,-117.93 191.72,-114.93 255,-115"/></g><!-- X1&#45;&#45;W1 --><g id="edge11" class="edge"><title>X1:e&#45;&#45;W1:w</title><path fill="none" stroke="#000000" stroke-width="2" d="M111,-87C173.14,-87.53 188.89,-78.53 255,-78"/><path fill="none" stroke="#ff8000" stroke-width="2" d="M111,-89C174.13,-89.26 189.88,-80.26 255,-80"/><path fill="none" stroke="#ff8000" stroke-width="2" d="M111,-91C175.12,-91 190.88,-82 255,-82"/><path fill="none" stroke="#ff8000" stroke-width="2" d="M111,-93C176.12,-92.74 191.87,-83.74 255,-84"/><path fill="none" stroke="#000000" stroke-width="2" d="M111,-95C177.11,-94.47 192.86,-85.47 255,-86"/></g><!-- X1&#45;&#45;W1 --><g id="edge13" class="edge"><title>X1:e&#45;&#45;W1:w</title><path fill="none" stroke="#000000" stroke-width="2" d="M111,-64C172.55,-65.14 187.85,-50.14 255,-49"/><path fill="none" stroke="#ffffff" stroke-width="2" d="M111,-66C173.95,-66.57 189.25,-51.57 255,-51"/><path fill="none" stroke="#895956" stroke-width="2" d="M111,-68C175.35,-68 190.65,-53 255,-53"/><path fill="none" stroke="#ffffff" stroke-width="2" d="M111,-70C176.75,-69.43 192.05,-54.43 255,-55"/><path fill="none" stroke="#000000" stroke-width="2" d="M111,-72C178.15,-70.86 193.45,-55.86 255,-57"/></g><!-- X1&#45;&#45;W1 --><g id="edge15" class="edge"><title>X1:e&#45;&#45;W1:w</title><path fill="none" stroke="#000000" stroke-width="2" d="M111,-41C172.4,-42.71 187.04,-21.71 255,-20"/><path fill="none" stroke="#895956" stroke-width="2" d="M111,-43C174.04,-43.86 188.68,-22.86 255,-22"/><path fill="none" stroke="#895956" stroke-width="2" d="M111,-45C175.68,-45 190.32,-24 255,-24"/><path fill="none" stroke="#895956" stroke-width="2" d="M111,-47C177.32,-46.14 191.96,-25.14 255,-26"/><path fill="none" stroke="#000000" stroke-width="2" d="M111,-49C178.96,-47.29 193.6,-26.29 255,-28"/></g><!-- X2 --><g id="node2" class="node"><title>X2</title><polygon fill="#ffffff" stroke="black" points="769,-264 658,-264 658,-34 769,-34 769,-264"/><polygon fill="none" stroke="black" points="658.5,-241 658.5,-264 769.5,-264 769.5,-241 658.5,-241"/><text text-anchor="start" x="705.5" y="-248.8" font-family="arial" font-size="14.00">X2</text><polygon fill="none" stroke="black" points="658.5,-218 658.5,-241 696.5,-241 696.5,-218 658.5,-218"/><text text-anchor="start" x="662.5" y="-225.8" font-family="arial" font-size="14.00">8p8c</text><polygon fill="none" stroke="black" points="696.5,-218 696.5,-241 730.5,-241 730.5,-218 696.5,-218"/><text text-anchor="start" x="700.5" y="-225.8" font-family="arial" font-size="14.00">plug</text><polygon fill="none" stroke="black" points="730.5,-218 730.5,-241 769.5,-241 769.5,-218 730.5,-218"/><text text-anchor="start" x="734.5" y="-225.8" font-family="arial" font-size="14.00">8&#45;pin</text><polygon fill="none" stroke="black" points="658.5,-195 658.5,-218 695.5,-218 695.5,-195 658.5,-195"/><text text-anchor="start" x="673" y="-202.8" font-family="arial" font-size="14.00">1</text><polygon fill="none" stroke="black" points="695.5,-195 695.5,-218 769.5,-218 769.5,-195 695.5,-195"/><text text-anchor="start" x="709.5" y="-202.8" font-family="arial" font-size="14.00">CAN_H</text><polygon fill="none" stroke="black" points="658.5,-172 658.5,-195 695.5,-195 695.5,-172 658.5,-172"/><text text-anchor="start" x="673" y="-179.8" font-family="arial" font-size="14.00">2</text><polygon fill="none" stroke="black" points="695.5,-172 695.5,-195 769.5,-195 769.5,-172 695.5,-172"/><text text-anchor="start" x="710.5" y="-179.8" font-family="arial" font-size="14.00">CAN_L</text><polygon fill="none" stroke="black" points="658.5,-149 658.5,-172 695.5,-172 695.5,-149 658.5,-149"/><text text-anchor="start" x="673" y="-156.8" font-family="arial" font-size="14.00">3</text><polygon fill="none" stroke="black" points="695.5,-149 695.5,-172 769.5,-172 769.5,-149 695.5,-149"/><text text-anchor="start" x="717" y="-156.8" font-family="arial" font-size="14.00">GND</text><polygon fill="none" stroke="black" points="658.5,-126 658.5,-149 695.5,-149 695.5,-126 658.5,-126"/><text text-anchor="start" x="673" y="-133.8" font-family="arial" font-size="14.00">4</text><polygon fill="none" stroke="black" points="695.5,-126 695.5,-149 769.5,-149 769.5,-126 695.5,-126"/><text text-anchor="start" x="716" y="-133.8" font-family="arial" font-size="14.00">+12V</text><polygon fill="none" stroke="black" points="658.5,-103 658.5,-126 695.5,-126 695.5,-103 658.5,-103"/><text text-anchor="start" x="673" y="-110.8" font-family="arial" font-size="14.00">5</text><polygon fill="none" stroke="black" points="695.5,-103 695.5,-126 769.5,-126 769.5,-103 695.5,-103"/><text text-anchor="start" x="716" y="-110.8" font-family="arial" font-size="14.00">+12V</text><polygon fill="none" stroke="black" points="658.5,-80 658.5,-103 695.5,-103 695.5,-80 658.5,-80"/><text text-anchor="start" x="673" y="-87.8" font-family="arial" font-size="14.00">6</text><polygon fill="none" stroke="black" points="695.5,-80 695.5,-103 769.5,-103 769.5,-80 695.5,-80"/><text text-anchor="start" x="717" y="-87.8" font-family="arial" font-size="14.00">GND</text><polygon fill="none" stroke="black" points="658.5,-57 658.5,-80 695.5,-80 695.5,-57 658.5,-57"/><text text-anchor="start" x="673" y="-64.8" font-family="arial" font-size="14.00">7</text><polygon fill="none" stroke="black" points="695.5,-57 695.5,-80 769.5,-80 769.5,-57 695.5,-57"/><text text-anchor="start" x="717" y="-64.8" font-family="arial" font-size="14.00">GND</text><polygon fill="none" stroke="black" points="658.5,-34 658.5,-57 695.5,-57 695.5,-34 658.5,-34"/><text text-anchor="start" x="673" y="-41.8" font-family="arial" font-size="14.00">8</text><polygon fill="none" stroke="black" points="695.5,-34 695.5,-57 769.5,-57 769.5,-34 695.5,-34"/><text text-anchor="start" x="716" y="-41.8" font-family="arial" font-size="14.00">+12V</text></g><!-- W1&#45;&#45;X2 --><g id="edge2" class="edge"><title>W1:e&#45;&#45;X2:w</title><path fill="none" stroke="#000000" stroke-width="2" d="M514,-223C575.4,-224.62 590.17,-204.62 658,-203"/><path fill="none" stroke="#ffffff" stroke-width="2" d="M514,-225C577.01,-225.81 591.78,-205.81 658,-205"/><path fill="none" stroke="#00ff00" stroke-width="2" d="M514,-227C578.61,-227 593.39,-207 658,-207"/><path fill="none" stroke="#ffffff" stroke-width="2" d="M514,-229C580.22,-228.19 594.99,-208.19 658,-209"/><path fill="none" stroke="#000000" stroke-width="2" d="M514,-231C581.83,-229.38 596.6,-209.38 658,-211"/></g><!-- W1&#45;&#45;X2 --><g id="edge4" class="edge"><title>W1:e&#45;&#45;X2:w</title><path fill="none" stroke="#000000" stroke-width="2" d="M514,-194C575.61,-195.04 591.01,-181.04 658,-180"/><path fill="none" stroke="#00ff00" stroke-width="2" d="M514,-196C576.96,-196.52 592.35,-182.52 658,-182"/><path fill="none" stroke="#00ff00" stroke-width="2" d="M514,-198C578.3,-198 593.7,-184 658,-184"/><path fill="none" stroke="#00ff00" stroke-width="2" d="M514,-200C579.65,-199.48 595.04,-185.48 658,-186"/><path fill="none" stroke="#000000" stroke-width="2" d="M514,-202C580.99,-200.96 596.39,-186.96 658,-188"/></g><!-- W1&#45;&#45;X2 --><g id="edge6" class="edge"><title>W1:e&#45;&#45;X2:w</title><path fill="none" stroke="#000000" stroke-width="2" d="M514,-165C576.29,-165.43 592.09,-157.43 658,-157"/><path fill="none" stroke="#ffffff" stroke-width="2" d="M514,-167C577.2,-167.22 593,-159.22 658,-159"/><path fill="none" stroke="#ff8000" stroke-width="2" d="M514,-169C578.1,-169 593.9,-161 658,-161"/><path fill="none" stroke="#ffffff" stroke-width="2" d="M514,-171C579,-170.78 594.8,-162.78 658,-163"/><path fill="none" stroke="#000000" stroke-width="2" d="M514,-173C579.91,-172.57 595.71,-164.57 658,-165"/></g><!-- W1&#45;&#45;X2 --><g id="edge8" class="edge"><title>W1:e&#45;&#45;X2:w</title><path fill="none" stroke="#000000" stroke-width="2" d="M514,-136C577.28,-136.07 593.25,-133.07 658,-133"/><path fill="none" stroke="#0066ff" stroke-width="2" d="M514,-138C577.64,-138.03 593.62,-135.03 658,-135"/><path fill="none" stroke="#0066ff" stroke-width="2" d="M514,-140C578.01,-140 593.99,-137 658,-137"/><path fill="none" stroke="#0066ff" stroke-width="2" d="M514,-142C578.38,-141.97 594.36,-138.97 658,-139"/><path fill="none" stroke="#000000" stroke-width="2" d="M514,-144C578.75,-143.93 594.72,-140.93 658,-141"/></g><!-- W1&#45;&#45;X2 --><g id="edge10" class="edge"><title>W1:e&#45;&#45;X2:w</title><path fill="none" stroke="#000000" stroke-width="2" d="M514,-107C578.75,-107.07 594.72,-110.07 658,-110"/><path fill="none" stroke="#ffffff" stroke-width="2" d="M514,-109C578.38,-109.03 594.36,-112.03 658,-112"/><path fill="none" stroke="#0066ff" stroke-width="2" d="M514,-111C578.01,-111 593.99,-114 658,-114"/><path fill="none" stroke="#ffffff" stroke-width="2" d="M514,-113C577.64,-112.97 593.62,-115.97 658,-116"/><path fill="none" stroke="#000000" stroke-width="2" d="M514,-115C577.28,-114.93 593.25,-117.93 658,-118"/></g><!-- W1&#45;&#45;X2 --><g id="edge12" class="edge"><title>W1:e&#45;&#45;X2:w</title><path fill="none" stroke="#000000" stroke-width="2" d="M514,-78C580.11,-78.53 595.86,-87.53 658,-87"/><path fill="none" stroke="#ff8000" stroke-width="2" d="M514,-80C579.12,-80.26 594.87,-89.26 658,-89"/><path fill="none" stroke="#ff8000" stroke-width="2" d="M514,-82C578.12,-82 593.88,-91 658,-91"/><path fill="none" stroke="#ff8000" stroke-width="2" d="M514,-84C577.13,-83.74 592.88,-92.74 658,-93"/><path fill="none" stroke="#000000" stroke-width="2" d="M514,-86C576.14,-85.47 591.89,-94.47 658,-95"/></g><!-- W1&#45;&#45;X2 --><g id="edge14" class="edge"><title>W1:e&#45;&#45;X2:w</title><path fill="none" stroke="#000000" stroke-width="2" d="M514,-49C581.15,-50.14 596.45,-65.14 658,-64"/><path fill="none" stroke="#ffffff" stroke-width="2" d="M514,-51C579.75,-51.57 595.05,-66.57 658,-66"/><path fill="none" stroke="#895956" stroke-width="2" d="M514,-53C578.35,-53 593.65,-68 658,-68"/><path fill="none" stroke="#ffffff" stroke-width="2" d="M514,-55C576.95,-54.43 592.25,-69.43 658,-70"/><path fill="none" stroke="#000000" stroke-width="2" d="M514,-57C575.55,-55.86 590.85,-70.86 658,-72"/></g><!-- W1&#45;&#45;X2 --><g id="edge16" class="edge"><title>W1:e&#45;&#45;X2:w</title><path fill="none" stroke="#000000" stroke-width="2" d="M514,-20C581.96,-21.71 596.6,-42.71 658,-41"/><path fill="none" stroke="#895956" stroke-width="2" d="M514,-22C580.32,-22.86 594.96,-43.86 658,-43"/><path fill="none" stroke="#895956" stroke-width="2" d="M514,-24C578.68,-24 593.32,-45 658,-45"/><path fill="none" stroke="#895956" stroke-width="2" d="M514,-26C577.04,-25.14 591.68,-46.14 658,-47"/><path fill="none" stroke="#000000" stroke-width="2" d="M514,-28C575.4,-26.29 590.04,-47.29 658,-49"/></g></g></svg></p>
<h2 id="power-handling"><a class="toclink" href="../../2024/05/03/can-on-8p8c-connectors/#power-handling">Power Handling</a></h2>
<div class="admonition info inline end">
<p class="admonition-title">Voltage Smoltage</p>
<p>I haven't actually settled on the voltage to use on the cabling. For
now, I am using +12V, but moving up to +48V would (basically)
quadruple the available power without requiring any additional
copper. It does, however, somewhat complicate the individual device
power supplies.</p>
</div>
<p>At this point, I'm planning to run +12V across the cable to allow for
most things to be powered off the central device. Given I use solid
rather than stranded cables, we can the <a href="https://www.engineeringtoolbox.com/wire-gauges-d_419.html">standard AWG wire
gauge</a>
ratings of 3.5A on a 24 AWG single-core wire.</p>
<p>Now we can't do the math quite yet, as we need to
<a href="https://en.wikipedia.org/wiki/Derating">derate</a> the wire based on two
different factors, according to the
<a href="https://en.wikipedia.org/wiki/National_Electrical_Code">NEC</a>:</p>
<ol>
<li>Ambient operating temperature</li>
<li>More than 3 wires in a cable</li>
</ol>
<p>So, if we do the math for operating at 40C (104F), and with the 3 power
carrying conductors in the cable, we get derating factors of 0.88 and
0.80 respectively. So...</p>
<div class="arithmatex">\[\begin{align}
P &amp;= 3 (3.5A \times 0.88 \times 0.80) \\
  &amp;= 3 (2.464) \\
  &amp;= 7.392A
\end{align}
\]</div>
<p>So that means we can do 7.392 * 12 = 88.7W of power on the cable. <em>But
there's a catch</em>. The current most advanced power-over-ethernet (PoE)
standard, IEEE 802.3bt-2018, says that each <em>pair of conductors</em> is
designed to handle 960mA, which would actually put us at (generously!)
960 &times; 2 or 1.92A, or 23W at 12V.</p>
<p>This is the reason I'm thinking of switching to driving the cable with
48V, which would let me move up to 92W, which is about what the standard
allows. So, perhaps I will change to a 48V distribution, which will
require something like an <a href="https://www.ti.com/product/LM5576">LM5576</a>. </p>
<p>We'll burn that bridge when we come to it.</p>
<h3 id="quick-note-about-diagrams"><a class="toclink" href="../../2024/05/03/can-on-8p8c-connectors/#quick-note-about-diagrams">Quick Note About Diagrams</a></h3>
<p>The diagrams above were done with an amazing tool called
<a href="https://github.com/wireviz/WireViz/">Wireviz</a>, and embedded into the
MkDocs site you're reading using a little hacky <a href="https://github.com/petrilli/wireviz_fences">Markdown extension I
wrote</a>. </p>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
      <nav class="md-post__authors md-typeset">
        
          <span class="md-author">
            <img src="https://github.com/petrilli.png" alt="Christopher Petrilli">
          </span>
        
      </nav>
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2024-05-02 00:00:00">May 2, 2024</time></li>
        
          <li class="md-meta__item">
            in
            
              <a href="./" class="md-meta__link">Hardware</a></li>
        
        
          
          <li class="md-meta__item">
            
              5 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="a-bus-is-a-bus-of-course-of-course"><a class="toclink" href="../../2024/05/02/a-bus-is-a-bus-of-course-of-course/">A Bus is a Bus, Of Course, Of Course</a></h2>
<p>One of the defining features of the project is using a modular backplane
in a subrack enclosure. I figured we can dive into some of the details
so far.</p>
<h3 id="design-principles"><a class="toclink" href="../../2024/05/02/a-bus-is-a-bus-of-course-of-course/#design-principles">Design Principles</a></h3>
<p>When I was looking at how <a href="https://github.com/kiu/kha/">kha</a> structured
the bus, I decided to pull a few ideas from what they did:</p>
<ol>
<li>Leverage DIN 41612 for the physical format of the bus. This is a very
   well understood and documented specification, and it has been
   battle-tested over many decades.</li>
<li>Simplify the backplane routing requirement.</li>
<li>Carry both +12V and +5V. Can be locally regulated down to the needed
   voltage.</li>
</ol>
<h3 id="physical-connector"><a class="toclink" href="../../2024/05/02/a-bus-is-a-bus-of-course-of-course/#physical-connector">Physical Connector</a></h3>
<p>I decided to use the DIN 41612 connector because it is an absolute tank.
It has been used, at least, since the late 1980s in dozens and dozens of
critical systems. It's also relatively inexpensive and not very finicky
to work with.</p>
<p><img alt="View of the connector" src="../../img/din41612-3d-projection.png" /></p>
<p><img align="left" alt="Diagram showing a straight receptacle and a right-angle
plug" src="../../img/din41612-type-b.png" width="100" /></p>
<p>While kha used a 32-pin connector (2 rows of 16 pins), I've decided to
use a 64-pin connector. The reason is that this allows me to run many
more ground lines across the connector, and also double up the power. I
am using the DIN 41612 connector in it's type B configuration. This
means it has 2 rows of pins/contacts, labeled "a" and "b". The numbering
scheme is basically A1/B1-A32/B32. </p>
<p>There are many other arrangements that are used in other systems, and
many have 3 or 4 rows, but this is far more than enough for this setup.
It also keeps it from even starting to look like
<a href="https://en.wikipedia.org/wiki/VMEbus">VMEbus</a>, which uses a 3 row
96-pin version.</p>
<p><img alt="Pin numbering on a DIN 41612" src="../../img/din41612-contact-arrangement.png" /></p>
<p>In the type B configuration, the receptacle (female) connector is on the
backplane and the plug (male) is on the card at a right angle. While you
can get connectors reversed, I didn't see any reason to deviate from
this arrangement.</p>
<p>The connectors also have 2.8mm holes for M2.5 screws that allow them to
be <em>very securely</em> attached to the PCBs, without needing to put any
strain on the solder joints.</p>
<h3 id="signal-assignment"><a class="toclink" href="../../2024/05/02/a-bus-is-a-bus-of-course-of-course/#signal-assignment">Signal Assignment</a></h3>
<p>To simplify the routing enormously, I've decided to keep the "a" and "b"
rows identical. This allows for the bus to be routed straight across the
backplane. The "signals" can be broken down into a few groups:</p>
<ul>
<li>Ground</li>
<li>Power rails, both +12V and +5V</li>
<li>CAN bus (differential encoding)</li>
<li>User-defined signals (BUS_*)</li>
</ul>
<p>This breaks down to this layout, where ground is heavily interspersed
with the signals to help ensure reasonable signal integrity.</p>
<table>
<thead>
<tr>
<th>Pin #</th>
<th>Row A</th>
<th>Row B</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>GND</td>
<td>GND</td>
</tr>
<tr>
<td>2</td>
<td>+12</td>
<td>+12</td>
</tr>
<tr>
<td>3</td>
<td>+12</td>
<td>+12</td>
</tr>
<tr>
<td>4</td>
<td>+5</td>
<td>+5</td>
</tr>
<tr>
<td>5</td>
<td>+5</td>
<td>+5</td>
</tr>
<tr>
<td>6</td>
<td>GND</td>
<td>GND</td>
</tr>
<tr>
<td>7</td>
<td>CAN_H</td>
<td>CAN_H</td>
</tr>
<tr>
<td>8</td>
<td>GND</td>
<td>GND</td>
</tr>
<tr>
<td>9</td>
<td>CAN_L</td>
<td>CAN_L</td>
</tr>
<tr>
<td>10</td>
<td>GND</td>
<td>GND</td>
</tr>
<tr>
<td>11</td>
<td>BUS_00</td>
<td>BUS_00</td>
</tr>
<tr>
<td>12</td>
<td>BUS_01</td>
<td>BUS_01</td>
</tr>
<tr>
<td>13</td>
<td>GND</td>
<td>GND</td>
</tr>
<tr>
<td>14</td>
<td>BUS_02</td>
<td>BUS_02</td>
</tr>
<tr>
<td>15</td>
<td>BUS_03</td>
<td>BUS_03</td>
</tr>
<tr>
<td>16</td>
<td>GND</td>
<td>GND</td>
</tr>
<tr>
<td>17</td>
<td>BUS_04</td>
<td>BUS_04</td>
</tr>
<tr>
<td>18</td>
<td>BUS_05</td>
<td>BUS_05</td>
</tr>
<tr>
<td>19</td>
<td>GND</td>
<td>GND</td>
</tr>
<tr>
<td>20</td>
<td>BUS_06</td>
<td>BUS_06</td>
</tr>
<tr>
<td>21</td>
<td>BUS_07</td>
<td>BUS_07</td>
</tr>
<tr>
<td>22</td>
<td>GND</td>
<td>GND</td>
</tr>
<tr>
<td>23</td>
<td>BUS_08</td>
<td>BUS_08</td>
</tr>
<tr>
<td>24</td>
<td>BUS_09</td>
<td>BUS_09</td>
</tr>
<tr>
<td>25</td>
<td>GND</td>
<td>GND</td>
</tr>
<tr>
<td>26</td>
<td>GND</td>
<td>GND</td>
</tr>
<tr>
<td>27</td>
<td>GND</td>
<td>GND</td>
</tr>
<tr>
<td>28</td>
<td>+5</td>
<td>+5</td>
</tr>
<tr>
<td>29</td>
<td>+5</td>
<td>+5</td>
</tr>
<tr>
<td>30</td>
<td>+12</td>
<td>+12</td>
</tr>
<tr>
<td>31</td>
<td>+12</td>
<td>+12</td>
</tr>
<tr>
<td>32</td>
<td>GND</td>
<td>GND</td>
</tr>
</tbody>
</table>
<h3 id="power-capacity-and-derating"><a class="toclink" href="../../2024/05/02/a-bus-is-a-bus-of-course-of-course/#power-capacity-and-derating">Power Capacity and Derating</a></h3>
<p>One of the things I wanted to do is be able to carry 6-8A of current on
both the +12V and +5V rails. The standard for the connector specifies 2A
per pin, but you also need to
<a href="https://en.wikipedia.org/wiki/Derating">derate</a> this  number for use in
the real-world. If we look at Harting's derating curve, we get this:</p>
<p><img alt="A derating curve for DIN 41612 connectors from
Harting" src="../../img/din41612-derating-curve.png" /></p>
<p>Most standards talk about "room temperature" at 20C, but it's typically
necessary to actually use a higher temperature in the real world. The
resistance of the copper along with all the other components will raise
the ambient temperature. If we assume 35C (95F), then we can see on the
curve that we can expect about 1.8A. As I showed above, we are using 8
pins per rail, which gives us a safe load capacity of 14.4A, well above
what we are targeting. </p>
<p>We are actually safe, for this definition of safe at least, up to 98C
(208F), which is a temperature unlikely to occur in my house, even
without air conditioning in Seattle.</p>
<h3 id="pcb-layout"><a class="toclink" href="../../2024/05/02/a-bus-is-a-bus-of-course-of-course/#pcb-layout">PCB Layout</a></h3>
<p>The layout is actually pretty simple, and only needed 2 layers for the
initial run. Depending on what signal integrity looks like, I may
convert to 4 layers, but because I was able to keep the entire back as a
ground, basically, I have reasonable confidence. The top of the board
looks like this:</p>
<p><img alt="Top of PCB showing 7 slots" src="../../img/pcb-backplane-top-r1a.png" /></p>
<p><img align="right" alt="Cliff  FCR7350 connector" src="../../img/connector-cliff-fcr7350.png" width="200" /></p>
<p>You can see in the design how everything goes across horizontally, which
means there's no need to really "route" anything creatively. The ground
is tied together on both sides as the plated through holes connect the
two sides.</p>
<p>It has a 8C8P connector for CAN, two Cliff FCR7350 4mm safety banana
jacks for +12V and test points that can be used to check power and
signals. I also put all the signals on the silkscreen.</p>
<p>All mechanicals are in alignment with Eurocard and VMEbus standards.</p>
<p>You can find the <a href="https://github.com/rebma-io/hausrack/tree/main/hardware/pcb/backplane">KiCad files in GitHub</a>.</p>
    
  </div>
</article>
      
      
        
          



<nav class="md-pagination">
  
</nav>
        
      
    </div>
  </div>

          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright 2024 Christopher Petrilli
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../../..", "features": ["navigation.tabs", "header.autohide"], "search": "../../../assets/javascripts/workers/search.b8dbb3d2.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../../assets/javascripts/bundle.a7c05c9e.min.js"></script>
      
        <script src="../../../javascripts/mathjax.js"></script>
      
        <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      
    
  </body>
</html>